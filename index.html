<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰æŠ¥è¡¨è®¾è®¡å·¥å…·</title>
    <!-- Font Awesome -->
    <link href="css/font-awesome-4.7.0.min.css" rel="stylesheet">
    <!-- å¤–éƒ¨CSSå¼•ç”¨ -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/previewModal.css">
</head>

<body>

    <!-- æ ‡é¢˜æ  -->
    <!-- <div class="header">
        <span>ã€ä¿®æ”¹ã€‘æµ‹è¯•è‡ªå®šä¹‰æŠ¥è¡¨ 1</span>
    </div> -->

    <!-- ä¸»ä½“å®¹å™¨ -->
    <div class="main-container" style="display: flex !important;">

        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel" style="width: 200px !important; display: block !important; flex-shrink: 0;">
            <div class="panel-header" onclick="toggleSection('left-panel')">
                <h3>å·¥å…·æ </h3>
                <span id="left-panel-icon" class="collapse-icon">â—€</span>
            </div>
            <div id="left-panel-content">
                <!-- ç»´åº¦æ¨¡å—å·²ç§»é™¤ -->
                <div class="panel-section">
                    <div class="section-header">
                        <h3>æŒ‡æ ‡</h3>
                    </div>
                    <div class="indicator-tree">
                        <ul>
                            <li class="tree-item">
                                <span class="tree-node" onclick="toggleTreeNode(this)">
                                    <i class="tree-icon tree-folder tree-folder-open">â–¸</i>
                                    <i class="tree-folder-icon">ğŸ“</i>
                                    <span class="tree-text">å­˜æ¬¾æŒ‡æ ‡</span>
                                </span>
                                <ul class="tree-children">
                                    <li class="draggable indicator-item" draggable="true" data-type="indicator"
                                        data-name="ä¸ªäººå­˜æ¬¾ä½™é¢">
                                        <i class="tree-item-icon">â–«</i>
                                        <span class="tree-text">ä¸ªäººå­˜æ¬¾ä½™é¢</span>
                                    </li>
                                    <li class="draggable indicator-item" draggable="true" data-type="indicator"
                                        data-name="å¯¹å…¬å­˜æ¬¾ä½™é¢">
                                        <i class="tree-item-icon">â–«</i>
                                        <span class="tree-text">å¯¹å…¬å­˜æ¬¾ä½™é¢</span>
                                    </li>
                                    <li class="draggable indicator-item" draggable="true" data-type="indicator"
                                        data-name="æ€»å­˜æ¬¾ä½™é¢">
                                        <i class="tree-item-icon">â–«</i>
                                        <span class="tree-text">æ€»å­˜æ¬¾ä½™é¢</span>
                                    </li>
                                </ul>
                            </li>
                            <li class="tree-item">
                                <span class="tree-node" onclick="toggleTreeNode(this)">
                                    <i class="tree-icon tree-folder tree-folder-open">â–¸</i>
                                    <i class="tree-folder-icon">ğŸ“</i>
                                    <span class="tree-text">è´·æ¬¾æŒ‡æ ‡</span>
                                </span>
                                <ul class="tree-children">
                                    <li class="draggable indicator-item" draggable="true" data-type="indicator"
                                        data-name="ä¸ªäººè´·æ¬¾ä½™é¢">
                                        <i class="tree-item-icon">â–«</i>
                                        <span class="tree-text">ä¸ªäººè´·æ¬¾ä½™é¢</span>
                                    </li>
                                    <li class="draggable indicator-item" draggable="true" data-type="indicator"
                                        data-name="å¯¹å…¬è´·æ¬¾ä½™é¢">
                                        <i class="tree-item-icon">â–«</i>
                                        <span class="tree-text">å¯¹å…¬è´·æ¬¾ä½™é¢</span>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´åŒºåŸŸ -->
        <div class="center-panel" style="flex: 1 !important; display: flex !important; flex-direction: column !important;">
            <!-- æŸ¥è¯¢æ å·²ç§»é™¤ -->

            <!-- å·¥å…·æ¡ -->
            <div class="toolbar">
                <!-- æ–‡ä»¶æ“ä½œåŒº -->
                <div class="toolbar-group">
                    <button class="toolbar-btn save-btn"><i class="fa fa-save"></i></button>
                    <button class="toolbar-btn"><i class="fa fa-download"></i></button>
                    <button class="toolbar-btn clear-btn" title="æ¸…ç©ºé…ç½®"><i class="fa fa-trash"></i></button>
                    <button class="toolbar-btn preview-btn" title="é¢„è§ˆ"><i class="fa fa-eye"></i></button>
                    <button class="toolbar-btn view-page-btn" title="æŸ¥çœ‹é¡µ"><i class="fa fa-external-link"></i></button>
                </div>

                <!-- åˆ†éš”çº¿ -->
                <div class="toolbar-divider"></div>

                <!-- æ ¼å¼è®¾ç½®åŒº -->
                <div class="toolbar-group">
                    <div class="dropdown">
                        <button class="toolbar-btn dropdown-toggle"><i class="fa fa-table"></i></button>
                    </div>
                    <div class="dropdown">
                        <button id="font-color-btn" class="toolbar-btn dropdown-toggle" title="å­—ä½“é¢œè‰²">
                            <i class="fa fa-font"></i>
                        </button>
                        <div id="font-color-menu" class="dropdown-menu">
                            <div class="color-picker">
                                <div class="color-item" data-color="#000000" style="background-color: #000000;"></div>
                                <div class="color-item" data-color="#FF0000" style="background-color: #FF0000;"></div>
                                <div class="color-item" data-color="#0000FF" style="background-color: #0000FF;"></div>
                                <div class="color-item" data-color="#008000" style="background-color: #008000;"></div>
                                <div class="color-item" data-color="#FFA500" style="background-color: #FFA500;"></div>
                                <div class="color-item" data-color="#800080" style="background-color: #800080;"></div>
                                <div class="color-item" data-color="#FF00FF" style="background-color: #FF00FF;"></div>
                                <div class="color-item" data-color="#00FFFF" style="background-color: #00FFFF;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button id="fill-color-btn" class="toolbar-btn dropdown-toggle" title="å¡«å……è‰²"><i
                                class="fa fa-paint-brush"></i></button>
                        <div id="fill-color-menu" class="dropdown-menu">
                            <div class="color-picker">
                                <div class="color-item" data-color="#FFFFFF" style="background-color: #FFFFFF;"></div>
                                <div class="color-item" data-color="#FFFF00" style="background-color: #FFFF00;"></div>
                                <div class="color-item" data-color="#FFC0CB" style="background-color: #FFC0CB;"></div>
                                <div class="color-item" data-color="#ADD8E6" style="background-color: #ADD8E6;"></div>
                                <div class="color-item" data-color="#90EE90" style="background-color: #90EE90;"></div>
                                <div class="color-item" data-color="#D3D3D3" style="background-color: #D3D3D3;"></div>
                                <div class="color-item" data-color="#FFA07A" style="background-color: #FFA07A;"></div>
                                <div class="color-item" data-color="#E6E6FA" style="background-color: #E6E6FA;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button id="font-size-btn" class="toolbar-btn dropdown-toggle" title="å­—å·">
                            <i class="fa fa-text-height"></i>
                            <span class="font-size-value">10</span>
                        </button>
                        <div id="font-size-menu" class="dropdown-menu">
                            <div class="size-picker">
                                <div class="size-item" data-size="8">8</div>
                                <div class="size-item" data-size="10">10</div>
                                <div class="size-item" data-size="12">12</div>
                                <div class="size-item" data-size="14">14</div>
                                <div class="size-item" data-size="16">16</div>
                                <div class="size-item" data-size="18">18</div>
                                <div class="size-item" data-size="20">20</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åˆ†éš”çº¿ -->
                <div class="toolbar-divider"></div>

                <!-- æ–‡æœ¬æ ¼å¼åŒº -->
                <div class="toolbar-group">
                    <button id="bold-btn" class="toolbar-btn" title="åŠ ç²—"><i class="fa fa-bold"></i></button>
                    <button id="italic-btn" class="toolbar-btn" title="å€¾æ–œ"><i class="fa fa-italic"></i></button>
                    <button id="underline-btn" class="toolbar-btn" title="ä¸‹åˆ’çº¿"><i class="fa fa-underline"></i></button>
                </div>

                <!-- åˆ†éš”çº¿ -->
                <div class="toolbar-divider"></div>

                <!-- å¯¹é½æ–¹å¼åŒº -->
                <div class="toolbar-group">
                    <div class="dropdown">
                        <button class="toolbar-btn dropdown-toggle"><i class="fa fa-list-ul"></i></button>
                    </div>
                    <div class="dropdown">
                        <button class="toolbar-btn dropdown-toggle"><i class="fa fa-columns"></i></button>
                    </div>
                </div>
                
                <!-- åˆ†éš”çº¿ -->
                <div class="toolbar-divider"></div>
                
                <!-- è¡Œåˆ—æ“ä½œåŒº -->
                <div class="toolbar-group">
                    <button class="toolbar-btn" id="add-row-btn" title="æ·»åŠ è¡Œ"><i class="fa fa-plus"></i> è¡Œ</button>
                    <button class="toolbar-btn" id="add-col-btn" title="æ·»åŠ åˆ—"><i class="fa fa-plus"></i> åˆ—</button>
                </div>
            </div>

            <!-- å•å…ƒæ ¼é€‰ä¸­ä¿¡æ¯æ˜¾ç¤º -->
            <div class="cell-selection-info" id="cell-selection-info">
                <span class="cell-position">æœªé€‰ä¸­ä»»ä½•å•å…ƒæ ¼</span>
                <div class="cell-input-container">
                    <input type="text" class="cell-content-input" disabled placeholder="ç‚¹å‡»å•å…ƒæ ¼è¿›è¡Œç¼–è¾‘">
                </div>
            </div>

            <!-- è®¾è®¡åŒºåŸŸ -->
            <div class="design-area" id="design-area">
                <table id="design-table">
                        <thead>
                            <tr>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
            </div>
    </div>
    <!-- ç»“æŸ center-panel -->

    <!-- å³ä¾§ä¿¡æ¯æ  -->
    <div class="right-panel" style="width: 250px !important; display: block !important; flex-shrink: 0;">
        <div class="panel-header" onclick="toggleSection('right-panel')">
            <span id="right-panel-icon" class="collapse-icon">â–¶</span>
            <h3>å•å…ƒæ ¼ä¿¡æ¯</h3>
        </div>
        <div id="right-panel-content">
                <div class="cell-info" id="cell-info">
                    <div class="info-group">
                        <label>å•å…ƒæ ¼ç±»å‹:</label>
                        <select id="cell-type">
                            <option value="dimension">ç»´åº¦å•å…ƒæ ¼</option>
                            <option value="indicator" selected>æŒ‡æ ‡å•å…ƒæ ¼</option>
                            <option value="text">æ–‡æœ¬å•å…ƒæ ¼</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>å•å…ƒæ ¼ç¼–å·:</label>
                        <input type="text" id="cell-id" value="B3" readonly>
                    </div>
                    <div class="info-group">
                        <label>æ¥æºæŒ‡æ ‡:</label>
                        <input type="text" id="cell-source" value="ä¸ªäººå­˜æ¬¾ä½™é¢" readonly>
                    </div>
                    <div class="info-group">
                        <label>æ•°æ®å•ä½:</label>
                        <select id="cell-unit">
                            <option value="">æ— </option>
                            <option value="yuan">å…ƒ</option>
                            <option value="thousand">åƒå…ƒ</option>
                            <option value="million">ä¸‡å…ƒ</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>æ˜¾ç¤ºç²¾åº¦:</label>
                        <select id="cell-precision">
                            <option>0</option>
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>è®¡ç®—è§„åˆ™:</label>
                        <select id="cell-calc-rule">
                            <option value="today" selected>æœ¬æ—¥</option>
                            <option value="yesterday">æ˜¨æ—¥</option>
                            <option value="sum">æ±‚å’Œ</option>
                            <option value="avg">å¹³å‡å€¼</option>
                            <option value="count">è®¡æ•°</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>æ—¶é—´åº¦é‡:</label>
                        <select id="cell-time-unit">
                            <option value="none" selected>æ— </option>
                            <option value="day">æ—¥</option>
                            <option value="month">æœˆ</option>
                            <option value="quarter">å­£</option>
                            <option value="year">å¹´</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>å–å€¼æ–¹å¼:</label>
                        <select id="cell-value-type">
                            <option value="point" selected>æ—¶ç‚¹</option>
                            <option value="period">æ—¶æœŸ</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>æ•°æ®æ—¥æœŸ:</label>
                        <input type="date" id="cell-data-date">
                    </div>
                    <div class="info-group">
                        <label>å¸ç§:</label>
                        <select id="cell-currency">
                            <option value="CNY">äººæ°‘å¸(CNY)</option>
                            <option value="USD">ç¾å…ƒ(USD)</option>
                            <option value="EUR">æ¬§å…ƒ(EUR)</option>
                            <option value="JPY">æ—¥å…ƒ(JPY)</option>
                            <option value="HKD">æ¸¯å¸(HKD)</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>æœºæ„:</label>
                        <select id="cell-organization">
                            <option value="head">æ€»è¡Œ</option>
                            <option value="branch-shanghai">ä¸Šæµ·åˆ†è¡Œ</option>
                            <option value="branch-beijing">åŒ—äº¬åˆ†è¡Œ</option>
                            <option value="branch-guangzhou">å¹¿å·åˆ†è¡Œ</option>
                            <option value="branch-shenzhen">æ·±åœ³åˆ†è¡Œ</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!-- ç»“æŸ right-panel -->
    </div>
    <!-- ç»“æŸ main-container -->

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’®æ¨¡å— -->
    <div class="bottom-actions">
        <div class="actions-container">
            <button class="save-button">ä¿å­˜</button>
            <button class="cancel-button">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="preview-modal" class="preview-modal">
        <div id="modal-content" class="modal-content">
            <div class="modal-header">
                <h3>è¡¨æ ¼é¢„è§ˆ</h3>
                <button id="modal-close" class="modal-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <div id="preview-table-container" class="preview-table-container">
                    <table id="preview-table" class="preview-table">
                        <!-- è¡¨æ ¼å†…å®¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¿å­˜æ¨¡æ€æ¡† -->
    <div id="save-modal" class="preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¿å­˜é…ç½®</h3>
                <button id="save-modal-close" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="report-name">æŠ¥è¡¨è®¾è®¡å™¨åç§°:</label>
                    <input type="text" id="report-name" placeholder="è¯·è¾“å…¥æŠ¥è¡¨è®¾è®¡å™¨åç§°">
                </div>
                <div class="form-group">
                    <label for="config-name">é…ç½®åç§°:</label>
                    <input type="text" id="config-name" placeholder="è¯·è¾“å…¥é…ç½®åç§°">
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-confirm" class="confirm-button">ä¿å­˜</button>
                <button id="save-cancel" class="cancel-button">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¤–éƒ¨JavaScriptå¼•ç”¨ -->
    <script src="js/script.js"></script>
    <script src="js/queryHandler.js"></script>
    <script src="js/previewModule.js"></script>
    <script src="js/configManager.js"></script>
    <script src="js/sdkConfig.js"></script>
    <script src="js/toolbarActions.js"></script>
    <script src="http://10.238.171.159:8090/wp-core/api/getPanelXSdk"></script>
      <!-- <script>
      // æ ¹æ®ç¯å¢ƒåŠ¨æ€åŠ è½½ SDK
      const isDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const sdkUrl = isDev ? 'http://10.238.171.159:8090/wp-core/api/getPanelXSdk' : '/wp-core/api/getPanelXSdk';
      const script = document.createElement('script');
      script.src = sdkUrl;
      document.head.appendChild(script);
    </script>
    <!-- åŠ è½½SDKé…ç½®æ–‡ä»¶ -->
    <script>
        // åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶åŠ è½½SDKé…ç½®
        if (window.SDK_CONFIG_SETTINGS) {
            SDK_CONFIG_SETTINGS.loadFromFile('config/sdk-config.json')
                .then(() => {
                    console.log('SDKé…ç½®å·²åŠ è½½');
                    SDK_CONFIG_SETTINGS.printConfig();
                })
                .catch(error => {
                    console.warn('åŠ è½½SDKé…ç½®æ–‡ä»¶å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®:', error);
                });
        }
    </script>
    
    <!-- é…ç½®æ¥æ”¶ä¸åº”ç”¨è„šæœ¬ -->
    <script>
        // å…¨å±€ä¿å­˜èŠ‚ç‚¹ä¿¡æ¯å’Œå½“å‰è¡¨æ ¼é…ç½®
        window.currentNodeInfo = {
            nodeId: null,
            nodeName: null,
            nodeType: null,
            parentCode: null,
            config: null  // ä¿å­˜å½“å‰è¡¨æ ¼çš„config JSON
        };

        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            // æ£€æŸ¥æ¶ˆæ¯ç±»å‹
            if (event.data ) {
                try {
                    console.log('æ¥æ”¶åˆ°æ¶ˆæ¯:', event.data);
                    
                    // ä¿å­˜èŠ‚ç‚¹ä¿¡æ¯ç”¨äºä¿å­˜
                    if (event.data.nodeId !== undefined) {
                        window.currentNodeInfo = {
                            nodeId: event.data.nodeId || null,
                            nodeName: event.data.nodeName || null,
                            nodeType: event.data.type || null,
                            parentCode: event.data.parentCode || null,
                            config: event.data.config || null
                        };
                        console.log('å·²ä¿å­˜èŠ‚ç‚¹ä¿¡æ¯:', window.currentNodeInfo);
                    }
                    
                    console.log('æ¥æ”¶åˆ°è¡¨æ ¼é…ç½®:', event.data.config);
                    
                    // ç­‰å¾…DOMåŠ è½½å®Œæˆååº”ç”¨é…ç½®
                    if (document.readyState === 'complete') {
                        applyConfigToTable(event.data.config);
                    } else {
                        window.addEventListener('load', function() {
                            applyConfigToTable(event.data.config);
                        });
                    }
                } catch (error) {
                    console.error('å¤„ç†è¡¨æ ¼é…ç½®æ—¶å‡ºé”™:', error);
                }
            }
        });
        
        // åº”ç”¨é…ç½®åˆ°è¡¨æ ¼
        function applyConfigToTable(config) {
            // ç¡®ä¿applyTableConfigå‡½æ•°å¯ç”¨
            if (window.applyTableConfig) {
                console.log('åº”ç”¨é…ç½®åˆ°è¡¨æ ¼...');
                const success = window.applyTableConfig(config);
                
                if (success) {
                    console.log('è¡¨æ ¼é…ç½®åº”ç”¨æˆåŠŸ');
                    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„UIæ›´æ–°é€»è¾‘
                } else {
                    console.error('è¡¨æ ¼é…ç½®åº”ç”¨å¤±è´¥');
                }
            } else {
                console.error('applyTableConfigå‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿configManager.jså·²æ­£ç¡®åŠ è½½');
            }
        }
    </script>
</body>
</html>