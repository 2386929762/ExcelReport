<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥è¡¨èŠ‚ç‚¹ç®¡ç†ç³»ç»Ÿ</title>
    <script src="js/tailwindcss.min.js"></script>
    <script src="js/vue.global.prod.js"></script>
    <link href="css/font-awesome-6.5.1-all.min.css" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"> -->
    <link href="css/inter-font.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .tree-line {
            position: absolute;
            left: 11px;
            top: 24px;
            bottom: 0;
            width: 1px;
            background-color: #e2e8f0;
            z-index: 0;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Modal Transition */
        .modal-enter-active,
        .modal-leave-active {
            transition: opacity 0.3s ease;
        }

        .modal-enter-from,
        .modal-leave-to {
            opacity: 0;
        }

        /* é¿å… Vue æŒ‚è½½å‰æ¨¡æ¿å ä½å†…å®¹é—ªçƒ (v-cloak) */
        [v-cloak] {
            display: none !important;
        }

        /* åˆ·æ–°é—ªçƒåŠ¨ç”» */
        @keyframes flash-bg {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.0);
            }

            50% {
                box-shadow: 0 0 12px 4px rgba(34, 197, 94, 0.12);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.0);
            }
        }

        .refresh-flash {
            animation: flash-bg 0.6s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden flex flex-col">

    <div id="app" v-cloak class="h-full flex flex-col relative">

        <!-- <header class="bg-white border-b border-gray-200 h-16 flex items-center px-6 shadow-sm z-10 justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-md">
                    <i class="fa-solid fa-network-wired"></i>
                </div>
                <h1 class="text-xl font-semibold text-gray-800 tracking-tight">æŠ¥è¡¨èŠ‚ç‚¹ç®¡ç†ç³»ç»Ÿ</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm text-gray-500 bg-gray-50 px-3 py-1 rounded-full border border-gray-200">
                    <span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-2"></span>
                    æ•°æ®æº: {{ dataSourceType }}
                </div>
                <button @click="resetData" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                    <i class="fa-solid fa-rotate-right mr-1"></i> é‡ç½®æ•°æ®
                </button>
            </div>
        </header> -->

        <main class="flex-1 flex overflow-hidden">

            <aside
                class="w-80 bg-white border-r border-gray-200 flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-0">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">ç›®å½•ç»“æ„</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="refreshTree" :disabled="refreshLoading"
                            :class="['text-xs bg-white border px-2 py-1 rounded transition-colors shadow-sm', refreshLoading ? 'border-green-300 text-green-600' : 'border-gray-200 hover:border-green-500 hover:text-green-600 text-gray-600']"
                            title="åˆ·æ–°ç›®å½•">
                            <i :class="refreshLoading ? 'fa-solid fa-spinner fa-spin' : 'fa-solid fa-rotate-right'"></i>
                            <span v-if="!refreshLoading"> åˆ·æ–°</span>
                            <span v-else> åˆ·æ–°ä¸­</span>
                        </button>
                        <button @click="openAddRootModal"
                            class="text-xs bg-white border border-gray-200 hover:border-blue-500 hover:text-blue-600 text-gray-600 px-2 py-1 rounded transition-colors shadow-sm"
                            title="æ·»åŠ æ ¹ç›®å½•">
                            <i class="fa-solid fa-plus"></i> æ ¹èŠ‚ç‚¹
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-2 relative" :class="{ 'refresh-flash': refreshLoading }">
                    <template v-if="treeData.length > 0">
                        <tree-node v-for="node in treeData" :key="node['ç¼–å·']" :node="node" :selected-id="selectedNodeId"
                            @select="handleSelect" @add="openAddChildModal" @edit="openEditModal"
                            @delete="handleDelete"></tree-node>
                    </template>
                    <div v-else class="flex flex-col items-center justify-center h-full text-gray-400 text-sm">
                        <i class="fa-solid fa-folder-open text-3xl mb-2 opacity-50"></i>
                        <p>æš‚æ— æ•°æ®</p>
                    </div>
                </div>
            </aside>

            <section class="flex-1 bg-gray-50 relative overflow-hidden flex flex-col">

                <div v-if="!selectedNode"
                    class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                    <div
                        class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-4 text-gray-400 animate-pulse">
                        <i class="fa-solid fa-mouse-pointer text-4xl"></i>
                    </div>
                    <p class="text-lg font-medium text-gray-500">è¯·é€‰æ‹©å·¦ä¾§èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</p>
                    <p class="text-sm mt-2">ç‚¹å‡»ç›®å½•å¯å±•å¼€ï¼Œç‚¹å‡»æŠ¥è¡¨å¯æŸ¥çœ‹å†…å®¹</p>
                </div>

                <div v-else class="h-full flex flex-col">

                    <div class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0">
                        <div class="flex items-center text-sm text-gray-600">
                            <span class="font-medium text-gray-800">å½“å‰èŠ‚ç‚¹</span>
                            <span class="mx-2 text-gray-300">/</span>
                            <span class="text-blue-600">{{ selectedNode['èŠ‚ç‚¹å'] }}</span>
                        </div>
                        <!-- <div class="flex gap-2">
                            <button @click="switchToDetails" :class="rightPanelView === 'details' ? 'bg-gray-100 text-gray-900' : 'text-gray-500'" class="px-3 py-1.5 text-xs font-medium border border-transparent rounded hover:bg-gray-50 transition-colors">
                                <i class="fa-solid fa-circle-info mr-1"></i> å±æ€§è¯¦æƒ…
                            </button>
                             <button @click="switchToIframe" :class="rightPanelView === 'iframe' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'text-gray-500'" class="px-3 py-1.5 text-xs font-medium border border-transparent rounded hover:bg-gray-50 transition-colors">
                                <i class="fa-solid fa-laptop-code mr-1"></i> è®¾è®¡é¡µé¢
                            </button>
                            <div class="w-px h-6 bg-gray-200 mx-2"></div>
                            <button @click="openEditModal(selectedNode)" class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                                <i class="fa-solid fa-pen mr-1"></i> ç¼–è¾‘
                            </button>
                            <button @click="handleDelete(selectedNode)" class="px-3 py-1.5 text-xs font-medium text-red-600 bg-white border border-gray-300 rounded hover:bg-red-50 hover:border-red-200 transition-colors">
                                <i class="fa-solid fa-trash mr-1"></i> åˆ é™¤
                            </button>
                        </div> -->
                    </div>

                    <div class="flex-1 overflow-hidden relative">

                        <div v-if="rightPanelView === 'details'" class="h-full overflow-y-auto p-8 animate-fade-in">
                            <div class="max-w-4xl mx-auto">
                                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                                    <div class="flex items-start justify-between mb-6">
                                        <div class="flex items-center gap-4">
                                            <div :class="getNodeIconBg(selectedNode['èŠ‚ç‚¹ç±»å‹'])"
                                                class="w-12 h-12 rounded-lg flex items-center justify-center text-white text-xl shadow-sm">
                                                <i :class="getNodeIcon(selectedNode['èŠ‚ç‚¹ç±»å‹'])"></i>
                                            </div>
                                            <div>
                                                <h2 class="text-xl font-bold text-gray-900">{{ selectedNode['èŠ‚ç‚¹å'] }}
                                                </h2>
                                                <span
                                                    class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-500 border border-gray-200 mt-1 inline-block">
                                                    ç¼–å·: {{ selectedNode['ç¼–å·'] }}
                                                </span>
                                                <span
                                                    class="ml-2 text-xs px-2 py-0.5 rounded bg-blue-50 text-blue-600 border border-blue-100 mt-1 inline-block">
                                                    {{ selectedNode['èŠ‚ç‚¹ç±»å‹'] }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- <div class="grid grid-cols-2 gap-6 text-sm">
                                        <div>
                                            <p class="text-gray-500 mb-1">CODE</p>
                                            <p class="font-mono text-gray-700 bg-gray-50 p-2 rounded border border-gray-100 truncate">{{ selectedNode['ç¼–å·'] }}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-500 mb-1">çˆ¶èŠ‚ç‚¹ UUID</p>
                                            <p class="font-mono text-gray-700 bg-gray-50 p-2 rounded border border-gray-100 truncate">{{ selectedNode['parentCode'] || 'Root' }}</p>
                                        </div>
                                        <div class="col-span-2" v-if="selectedNode.json">
                                            <p class="text-gray-500 mb-1">JSON æ•°æ®</p>
                                            <pre class="bg-gray-800 text-gray-100 p-3 rounded-lg text-xs font-mono overflow-x-auto h-32">{{ selectedNode.json }}</pre>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                        </div>

                        <div v-else-if="rightPanelView === 'iframe'" class="w-full h-full bg-white flex flex-col">
                            <!-- <div class="bg-yellow-50 px-4 py-2 border-b border-yellow-100 text-yellow-800 text-xs flex justify-between items-center"> -->
                            <!-- <span><i class="fa-solid fa-triangle-exclamation mr-1"></i> ç¼–è¾‘æ¨¡å¼ ({{ getDesignPageName() }})</span>
                               <span class="font-mono opacity-70">
                                   <i class="fa-solid fa-paper-plane mr-1"></i>
                                   {{ selectedNode['èŠ‚ç‚¹å'] }} Config
                               </span> -->
                            <!-- </div> -->

                            <iframe :key="selectedNodeId" ref="iframeRef" @load="onIframeLoad" :src="getDesignPageUrl()"
                                class="w-full h-full border-0"
                                sandbox="allow-scripts allow-same-origin allow-forms allow-popups">
                            </iframe>
                        </div>

                    </div>
                </div>
            </section>
        </main>

        <transition name="modal">
            <div v-if="showModal"
                class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm">
                <div
                    class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-800">
                            {{ modalMode === 'add' ? 'æ–°å»ºèŠ‚ç‚¹' : 'ç¼–è¾‘èŠ‚ç‚¹' }}
                        </h3>
                        <button @click="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <div class="p-6">
                        <form @submit.prevent="confirmModal" id="nodeForm">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">èŠ‚ç‚¹åç§° <span
                                            class="text-red-500">*</span></label>
                                    <input v-model="modalForm.name" type="text" required
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2.5 outline-none transition-all"
                                        placeholder="è¯·è¾“å…¥åç§°" ref="nameInput">
                                </div>

                                <div v-if="modalMode === 'edit'">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç¼–å·/ID <span
                                            class="text-gray-400 text-xs font-normal">(åªè¯»)</span></label>
                                    <input v-model="modalForm.id" type="text" disabled
                                        class="w-full rounded-md border-gray-300 shadow-sm sm:text-sm border p-2.5 outline-none bg-gray-100 text-gray-500 cursor-not-allowed">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">èŠ‚ç‚¹ç±»å‹ <span
                                            class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <select v-model="modalForm.type" :disabled="modalMode === 'edit'"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2.5 outline-none bg-white appearance-none disabled:bg-gray-100 disabled:text-gray-500">
                                            <option value="ç›®å½•">ğŸ“‚ ç›®å½• (Directory)</option>
                                            <option value="æŒ‡æ ‡æŠ¥è¡¨">ğŸ“Š æŒ‡æ ‡æŠ¥è¡¨ (Report)</option>
                                            <option value="æ˜ç»†æŠ¥è¡¨">ğŸ“‘ æ˜ç»†æŠ¥è¡¨ (Detail)</option>
                                        </select>
                                        <div
                                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <i class="fa-solid fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>
                                    <p v-if="modalMode === 'edit'" class="text-xs text-yellow-600 mt-1">
                                        <i class="fa-solid fa-info-circle"></i> ç¼–è¾‘æ¨¡å¼ä¸‹æ— æ³•ä¿®æ”¹èŠ‚ç‚¹ç±»å‹
                                    </p>
                                </div>

                                <div v-if="modalMode === 'add'"
                                    class="text-xs text-gray-500 pt-2 border-t border-gray-100 mt-4">
                                    <span class="font-semibold">çˆ¶èŠ‚ç‚¹:</span>
                                    {{ modalForm.parentName || 'æ ¹èŠ‚ç‚¹ (Root)' }}
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end gap-3">
                        <button type="button" @click="closeModal"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" form="nodeForm"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none transition-colors">
                            ç¡®è®¤ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>

            <!-- Confirm Dialog -->
            <div v-if="showConfirmDialog"
                class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800">
                            {{ confirmDialogData.title }}
                        </h3>
                    </div>

                    <div class="p-6">
                        <p class="text-gray-700 text-base">
                            {{ confirmDialogData.message }}
                        </p>
                    </div>

                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end gap-3">
                        <button @click="cancelAction"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button @click="confirmAction"
                            class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-lg shadow-sm hover:bg-red-700 focus:outline-none transition-colors">
                            ç¡®è®¤åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script type="text/x-template" id="tree-node-template">
        <div class="relative pl-4 select-none">
            <div v-if="depth > 0" class="tree-line"></div>
            
            <div 
                class="group relative flex items-center justify-between p-2 rounded-md cursor-pointer transition-all duration-200 border border-transparent hover:bg-gray-100 mb-1"
                :class="{'bg-blue-50 border-blue-100': isSelected}"
                @click.stop="handleClick"
            >
                <div class="flex items-center gap-2 overflow-hidden">
                    <span 
                        v-if="isFolder" 
                        @click.stop="toggle" 
                        class="w-5 h-5 flex items-center justify-center rounded hover:bg-gray-200 text-gray-400 transition-colors"
                    >
                        <i :class="isOpen ? 'fa-solid fa-caret-down text-gray-600' : 'fa-solid fa-caret-right'"></i>
                    </span>
                    <span v-else class="w-5 h-5"></span>

                    <i :class="[getIconClass, isSelected ? 'text-blue-600' : 'text-gray-500']" class="text-sm"></i>
                    
                    <span class="text-sm font-medium truncate" :class="isSelected ? 'text-blue-700' : 'text-gray-700'">
                        {{ node['èŠ‚ç‚¹å'] }}
                    </span>
                </div>

                <div class="hidden group-hover:flex items-center gap-1 bg-gray-100 pl-2 rounded-l shadow-sm absolute right-1">
                    <button v-if="isFolder" @click.stop="$emit('add', node)" title="æ·»åŠ å­èŠ‚ç‚¹" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-blue-100 hover:text-blue-600 text-gray-400 text-xs transition-colors">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button @click.stop="$emit('edit', node)" title="ç¼–è¾‘" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-yellow-100 hover:text-yellow-600 text-gray-400 text-xs transition-colors">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <button @click.stop="$emit('delete', node)" title="åˆ é™¤" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-100 hover:text-red-600 text-gray-400 text-xs transition-colors">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>

            <transition name="fade">
                <div v-if="isFolder && isOpen" class="relative">
                    <tree-node 
                        v-for="child in node.children" 
                        :key="child['ç¼–å·']" 
                        :node="child"
                        :depth="depth + 1"
                        :selected-id="selectedId"
                        @select="$emit('select', $event)"
                        @add="$emit('add', $event)"
                        @edit="$emit('edit', $event)"
                        @delete="$emit('delete', $event)"
                    ></tree-node>
                </div>
            </transition>
        </div>
    </script>

    <!-- SDK Preload - Must be first -->
    <script src="js/preload.js" devSdkUrl="http://183.6.70.7:24689/wp-core/api/getPanelXSdk"></script>
    <script src="js/sdkConfig.js"></script>
    <script>
        // SDKè„šæœ¬æ— æ³•ç¦»çº¿è®¿é—®ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤URLè¿›è¡Œå¼€å‘æµ‹è¯•

        const { createApp, ref, computed, reactive, onMounted, nextTick } = Vue;

        // å…¨å±€SDKå®ä¾‹
        let sdk = null;

        /**
         * è°ƒç”¨SDKä¿å­˜æ ‘èŠ‚ç‚¹ä¿¡æ¯
         * @param {Object} nodeInfo - èŠ‚ç‚¹ä¿¡æ¯
         * @param {string} nodeInfo.nodeName - èŠ‚ç‚¹å
         * @param {string} nodeInfo.nodeType - èŠ‚ç‚¹ç±»å‹
         * @param {string} nodeInfo.parentCode - çˆ¶èŠ‚ç‚¹ç¼–å·
         * @param {string} nodeInfo.nodeId - èŠ‚ç‚¹ç¼–å·ï¼ˆç¼–è¾‘æ—¶ä¼ å…¥ï¼Œæ–°å»ºæ—¶ä¸ä¼ ï¼‰
         * @returns {Object} SDKè¿”å›ç»“æœ
         */
        async function callSDKSaveNode(nodeInfo) {
            try {
                if (!sdk) {
                    sdk = await window.initializeSDK();
                }

                if (!sdk || !sdk.api) {
                    throw new Error('SDKåˆå§‹åŒ–å¤±è´¥æˆ–ä¸å¯ç”¨');
                }

                // ä»é…ç½®ä¸­è·å–ä¿å­˜æŒ‰é’®é…ç½®
                const saveButtonConfig = window.getSaveButtonConfig();

                // æ„å»ºè¡¨å•æ•°æ®
                const formData = {
                    "èŠ‚ç‚¹å": nodeInfo.nodeName,
                    "èŠ‚ç‚¹ç±»å‹": nodeInfo.nodeType || "æŒ‡æ ‡æŠ¥è¡¨"
                };

                // åªæœ‰å½“parentCodeæœ‰å€¼æ—¶æ‰æ·»åŠ åˆ°formDataï¼ˆæ ¹èŠ‚ç‚¹ä¸éœ€è¦ä¼ parentCodeï¼‰
                if (nodeInfo.parentCode) {
                    formData["parentCode"] = nodeInfo.parentCode;
                }

                // ç¼–è¾‘æ—¶ä¼ å…¥ç¼–å·ï¼Œæ–°å»ºæ—¶ä¸ä¼ 
                if (nodeInfo.nodeId) {
                    formData["ç¼–å·"] = nodeInfo.nodeId;
                }

                console.log('è°ƒç”¨SDKä¿å­˜èŠ‚ç‚¹ï¼Œå‚æ•°:', {
                    panelCode: saveButtonConfig.panelCode,
                    buttonName: saveButtonConfig.buttonName,
                    formData: formData
                });

                // è°ƒç”¨SDKæ¥å£
                const result = await sdk.api.callButton({
                    "panelCode": saveButtonConfig.panelCode,
                    "buttonName": saveButtonConfig.buttonName,
                    "formData": formData
                });

                console.log('SDKä¿å­˜èŠ‚ç‚¹è¿”å›ç»“æœ:', result);
                return result;
            } catch (error) {
                console.error('SDKä¿å­˜èŠ‚ç‚¹å¤±è´¥:', error);
                throw error;
            }
        }

        // --- Default Mock Data ---
        const DEFAULT_DATA = [
            { "ç¼–å·": "000", "èŠ‚ç‚¹å": "çˆ¶èŠ‚ç‚¹", "èŠ‚ç‚¹ç±»å‹": "ç›®å½•" },
            // ç¡®ä¿è¿™ä¸¤ä¸ªèŠ‚ç‚¹çš„ JSON æ•°æ®ä¸åŒï¼Œä»¥ä¾¿æµ‹è¯•æ•°æ®æ˜¯å¦æ›´æ–°
            { "ç¼–å·": "002", "èŠ‚ç‚¹å": "æµ‹è¯•æ˜ç»† (ID: 002)", "èŠ‚ç‚¹ç±»å‹": "æ˜ç»†æŠ¥è¡¨", "parentCode": "000", "json": "{\"reportType\": \"detail\", \"dataKey\": \"a\"}" },
            { "ç¼–å·": "001", "èŠ‚ç‚¹å": "æµ‹è¯•æŒ‡æ ‡ (ID: 001)", "èŠ‚ç‚¹ç±»å‹": "æŒ‡æ ‡æŠ¥è¡¨", "json": "{\"reportType\": \"indicator\", \"dataKey\": \"b\"}", "parentCode": "000" }
        ];

        // --- Tree Node Component ---
        const TreeNode = {
            template: '#tree-node-template',
            name: 'TreeNode',
            props: ['node', 'selectedId', 'depth'],
            emits: ['select', 'add', 'edit', 'delete'],
            setup(props, { emit }) {
                const isOpen = ref(false);
                if (props.depth === 0) isOpen.value = true;

                const isFolder = computed(() => props.node['èŠ‚ç‚¹ç±»å‹'] === 'ç›®å½•');
                const isSelected = computed(() => props.node['ç¼–å·'] === props.selectedId);
                const getIconClass = computed(() => {
                    const type = props.node['èŠ‚ç‚¹ç±»å‹'];
                    if (type === 'ç›®å½•') return isOpen.value ? 'fa-regular fa-folder-open text-yellow-500' : 'fa-regular fa-folder text-yellow-500';
                    if (type === 'æŒ‡æ ‡æŠ¥è¡¨') return 'fa-solid fa-chart-pie text-purple-500';
                    if (type === 'æ˜ç»†æŠ¥è¡¨') return 'fa-solid fa-table-list text-green-500';
                    return 'fa-regular fa-file';
                });

                const toggle = () => { if (isFolder.value) isOpen.value = !isOpen.value; };
                const handleClick = () => { emit('select', props.node); if (isFolder.value) toggle(); };

                return { isOpen, isFolder, isSelected, getIconClass, toggle, handleClick };
            }
        };

        // --- Main App ---
        createApp({
            components: { TreeNode },
            setup() {
                // State
                const flatList = ref([]);
                const selectedNodeId = ref(null);
                const dataSourceType = ref('é»˜è®¤æ•°æ®');
                const rightPanelView = ref('details');
                const iframeRef = ref(null); // Reference to the iframe element

                // Modal State
                const showModal = ref(false);
                const modalMode = ref('add'); // 'add' | 'edit'
                const modalForm = ref({
                    name: '',
                    id: '',
                    type: 'ç›®å½•',
                    parentCode: '',
                    parentName: ''
                });
                const nameInput = ref(null);
                const refreshLoading = ref(false);

                // Confirm Dialog State
                const showConfirmDialog = ref(false);
                const confirmDialogData = ref({
                    title: '',
                    message: '',
                    confirmCallback: null,
                    cancelCallback: null
                });

                // --- Data Loading ---
                const loadData = async () => {
                    let finalData = [];
                    let source = 'é»˜è®¤æ•°æ®';
                    try {
                        if (!sdk) sdk = await window.initializeSDK();
                        if (sdk && sdk.api) {
                            const res = await sdk.api.queryFormDataList({
                                panelCode: 'OctoCM_BDYTH_IML_00001',
                                pageNo: 1,
                                pageSize: 200
                            });
                            if (res?.data?.list) {
                                finalData = res.data.list;
                                source = 'SDK æ•°æ®';
                            }
                        }
                    } catch (e) { console.error(e); }

                    if ((!finalData || finalData.length === 0) && typeof externalJsonData !== 'undefined' && externalJsonData?.data?.list) {
                        finalData = externalJsonData.data.list;
                        source = 'å¤–éƒ¨æ¥å£';
                    }

                    if (!finalData || finalData.length === 0) {
                        finalData = JSON.parse(JSON.stringify(DEFAULT_DATA));
                        source = 'é»˜è®¤æ•°æ®';
                    }

                    flatList.value = finalData;
                    dataSourceType.value = source;
                };

                // --- Tree Logic ---
                const treeData = computed(() => {
                    const data = JSON.parse(JSON.stringify(flatList.value));
                    const map = {};
                    const roots = [];
                    data.forEach(node => { node.children = []; map[node['ç¼–å·']] = node; });
                    data.forEach(node => {
                        if (node['parentCode'] && map[node['parentCode']]) {
                            map[node['parentCode']].children.push(node);
                        } else {
                            roots.push(node);
                        }
                    });
                    return roots;
                });

                const selectedNode = computed(() => flatList.value.find(n => n['ç¼–å·'] === selectedNodeId.value));

                // æ ¹æ®èŠ‚ç‚¹ç±»å‹è·å–è®¾è®¡é¡µé¢URL
                const getDesignPageUrl = () => {
                    if (!selectedNode.value) return './index.html';
                    const nodeType = selectedNode.value['èŠ‚ç‚¹ç±»å‹'];
                    if (nodeType === 'æ˜ç»†æŠ¥è¡¨') {
                        return './expenseStatement.html';
                    }
                    return './index.html';
                };

                // è·å–è®¾è®¡é¡µé¢åç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                const getDesignPageName = () => {
                    if (!selectedNode.value) return 'index.html';
                    const nodeType = selectedNode.value['èŠ‚ç‚¹ç±»å‹'];
                    if (nodeType === 'æ˜ç»†æŠ¥è¡¨') {
                        return 'expenseStatement.html';
                    }
                    return 'index.html';
                };

                // --- Iframe Communication Helper ---
                const sendMessageToIframe = (node) => {
                    const iframe = iframeRef.value;
                    if (iframe && iframe.contentWindow && node) {
                        let configData = {};
                        try {
                            configData = typeof node.json === 'string' ? JSON.parse(node.json) : node.json;
                        } catch (e) {
                            console.error("Error parsing JSON config:", e);
                            configData = {};
                        }

                        // Post Message
                        iframe.contentWindow.postMessage({
                            type: node['èŠ‚ç‚¹ç±»å‹'],
                            config: configData,
                            nodeId: node['ç¼–å·'] || null,
                            nodeName: node['èŠ‚ç‚¹å'],
                            parentCode: node['parentCode'] || null
                        }, '*');

                        // Console Log for Verification
                        console.log(`%c[Iframe Msg SENT] %cID: ${node['ç¼–å·']}, Name: ${node['èŠ‚ç‚¹å']}. Data:`, 'color: green; font-weight: bold;', 'color: black;', configData);
                    }
                };

                // Event: Iframe Loaded
                const onIframeLoad = () => {
                    // Console Log for Verification
                    console.log(`%c[Iframe LOADED] %cIframe for node ID ${selectedNodeId.value} just loaded.`, 'color: orange; font-weight: bold;', 'color: black;');

                    if (selectedNode.value) {
                        sendMessageToIframe(selectedNode.value);
                    }
                };

                // --- Actions ---

                const handleSelect = (node) => {
                    selectedNodeId.value = node['ç¼–å·'];

                    // åˆ¤æ–­èŠ‚ç‚¹ç±»å‹ï¼Œå¦‚æœæ˜¯æŠ¥è¡¨ç±»å‹åˆ™æŸ¥è¯¢SDKæ•°æ®
                    if ((node['èŠ‚ç‚¹ç±»å‹'] === 'æŒ‡æ ‡æŠ¥è¡¨' || node['èŠ‚ç‚¹ç±»å‹'] === 'æ˜ç»†æŠ¥è¡¨') && sdk && sdk.api) {
                        const params = {
                            "panelCode": "IML_00001",
                            "condition": {
                                "code": node['ç¼–å·']
                            }
                        };

                        console.log('å¼€å§‹æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®ï¼Œå‚æ•°:', params);

                        sdk.api.queryFormData(params)
                            .then(result => {
                                console.log('SDKæŸ¥è¯¢æˆåŠŸï¼Œè¿”å›ç»“æœ:', result);

                                // å¦‚æœæŸ¥è¯¢åˆ°æ•°æ®ï¼Œä½¿ç”¨æŸ¥è¯¢è¿”å›çš„ä¿¡æ¯æ‰“å¼€iframe
                                if (result && result.data && result.data.list && result.data.list.length > 0) {
                                    const queryData = result.data.list[0]; // è·å–ç¬¬ä¸€æ¡ç»“æœ
                                    console.log('è·å–åˆ°èŠ‚ç‚¹é…ç½®æ•°æ®:', queryData);

                                    // æ›´æ–°æœ¬åœ°èŠ‚ç‚¹çš„jsonå­—æ®µ
                                    if (queryData.json) {
                                        const nodeIndex = flatList.value.findIndex(n => n['ç¼–å·'] === queryData['ç¼–å·']);
                                        if (nodeIndex !== -1) {
                                            flatList.value[nodeIndex].json = queryData.json;
                                            console.log('å·²æ›´æ–°èŠ‚ç‚¹é…ç½®');
                                        }
                                    }

                                    // åˆ‡æ¢åˆ°iframeè§†å›¾
                                    rightPanelView.value = 'iframe';

                                    // ç”¨æŸ¥è¯¢è¿”å›çš„æ•°æ®æ„å»ºæ¶ˆæ¯ï¼Œå‘é€ç»™iframe
                                    nextTick(() => {
                                        const iframeWindow = document.getElementById('designerIframe')?.contentWindow;
                                        if (iframeWindow) {
                                            const messageData = {
                                                type: 'loadConfig',
                                                nodeId: queryData['ç¼–å·'],
                                                nodeName: queryData['èŠ‚ç‚¹å'],
                                                parentCode: queryData['parentCode'],
                                                config: typeof queryData.json === 'string' ? JSON.parse(queryData.json) : queryData.json
                                            };
                                            console.log('å‘é€æŸ¥è¯¢ç»“æœç»™iframe:', messageData);
                                            iframeWindow.postMessage(messageData, '*');
                                        }
                                    });
                                } else {
                                    console.error('æŸ¥è¯¢æœªè¿”å›æœ‰æ•ˆæ•°æ®ï¼Œä½¿ç”¨æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯');
                                    rightPanelView.value = 'iframe';
                                    nextTick(() => {
                                        if (selectedNode.value) sendMessageToIframe(selectedNode.value);
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('SDKæŸ¥è¯¢å¤±è´¥:', error);
                                // æŸ¥è¯¢å¤±è´¥æ—¶ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®æ‰“å¼€iframe
                                rightPanelView.value = 'iframe';
                                nextTick(() => {
                                    if (selectedNode.value) sendMessageToIframe(selectedNode.value);
                                });
                            });
                    } else if (node['èŠ‚ç‚¹ç±»å‹'] === 'æŒ‡æ ‡æŠ¥è¡¨' || node['èŠ‚ç‚¹ç±»å‹'] === 'æ˜ç»†æŠ¥è¡¨') {
                        // SDKä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®æ‰“å¼€iframe
                        rightPanelView.value = 'iframe';
                        nextTick(() => {
                            if (selectedNode.value) sendMessageToIframe(selectedNode.value);
                        });
                    } else {
                        // éæŠ¥è¡¨ç±»å‹åˆ™åˆ‡æ¢åˆ°è¯¦æƒ…è§†å›¾
                        rightPanelView.value = 'details';
                    }
                };

                const switchToDetails = () => rightPanelView.value = 'details';
                const switchToIframe = () => {
                    rightPanelView.value = 'iframe';
                    nextTick(() => {
                        // å¦‚æœè§†å›¾å·²ç»åœ¨ iframeï¼Œä¸”èŠ‚ç‚¹æœªå˜ï¼Œåˆ™æ‰‹åŠ¨å‘é€æ¶ˆæ¯
                        if (selectedNode.value) sendMessageToIframe(selectedNode.value);
                    });
                };

                // Confirm Dialog Functions
                const showConfirm = (title, message, confirmCallback, cancelCallback) => {
                    confirmDialogData.value = {
                        title,
                        message,
                        confirmCallback,
                        cancelCallback
                    };
                    showConfirmDialog.value = true;
                };

                const confirmAction = () => {
                    if (confirmDialogData.value.confirmCallback) {
                        confirmDialogData.value.confirmCallback();
                    }
                    showConfirmDialog.value = false;
                };

                const cancelAction = () => {
                    if (confirmDialogData.value.cancelCallback) {
                        confirmDialogData.value.cancelCallback();
                    }
                    showConfirmDialog.value = false;
                };

                // Modal: Add Root
                const openAddRootModal = () => {
                    modalMode.value = 'add';
                    modalForm.value = {
                        name: '',
                        id: '',  // ä¸å†å‰ç«¯ç”Ÿæˆ,ç­‰å¾…SDKè¿”å›
                        type: 'æŒ‡æ ‡æŠ¥è¡¨',
                        parentCode: '',
                        parentName: ''
                    };
                    showModal.value = true;
                    nextTick(() => nameInput.value?.focus());
                };

                // Modal: Add Child
                const openAddChildModal = (parentNode) => {
                    modalMode.value = 'add';
                    modalForm.value = {
                        name: '',
                        id: '',  // ä¸å†å‰ç«¯ç”Ÿæˆ,ç­‰å¾…SDKè¿”å›
                        type: 'æŒ‡æ ‡æŠ¥è¡¨',
                        parentCode: parentNode['ç¼–å·'],
                        parentName: parentNode['èŠ‚ç‚¹å']
                    };
                    showModal.value = true;
                    nextTick(() => nameInput.value?.focus());
                };

                // Modal: Edit
                const openEditModal = (node) => {
                    modalMode.value = 'edit';
                    modalForm.value = {
                        name: node['èŠ‚ç‚¹å'],
                        id: node['ç¼–å·'],
                        type: node['èŠ‚ç‚¹ç±»å‹'],
                        parentCode: node['parentCode'],
                    };
                    showModal.value = true;
                    nextTick(() => nameInput.value?.focus());
                };

                const closeModal = () => {
                    showModal.value = false;
                };

                // Modal: Submit
                const confirmModal = async () => {
                    if (modalMode.value === 'add') {
                        // Add Logic - Call SDK to save new node
                        const newNode = {
                            "ç¼–å·": modalForm.value.id,
                            "èŠ‚ç‚¹å": modalForm.value.name,
                            "èŠ‚ç‚¹ç±»å‹": modalForm.value.type,
                            "parentCode": modalForm.value.parentCode,
                            "json": "{}"
                        };

                        try {
                            // æ ¹èŠ‚ç‚¹ä¸ä¼ parentCodeï¼Œå­èŠ‚ç‚¹ä¼ parentCode
                            const saveParams = {
                                nodeName: newNode['èŠ‚ç‚¹å'],
                                nodeType: newNode['èŠ‚ç‚¹ç±»å‹']
                            };

                            // åªæœ‰å½“parentCodeä¸ä¸ºç©ºæ—¶æ‰ä¼ å…¥ï¼ˆæ ¹èŠ‚ç‚¹çš„parentCodeä¸ºç©ºï¼‰
                            if (modalForm.value.parentCode) {
                                saveParams.parentCode = modalForm.value.parentCode;
                            }

                            console.log('è°ƒç”¨SDKä¿å­˜æ–°å»ºèŠ‚ç‚¹:', saveParams);

                            // è°ƒç”¨SDKä¿å­˜æ¥å£ï¼ˆæ–°å»ºä¸ä¼ ç¼–å·ï¼‰
                            const result = await callSDKSaveNode(saveParams);

                            if (result && result.state === '200') {
                                console.log('SDKä¿å­˜æˆåŠŸï¼Œè¿”å›ç»“æœ:', result);

                                // ä»SDKè¿”å›å€¼ä¸­è·å–èŠ‚ç‚¹ç¼–å·
                                if (result.data && result.data.data && result.data.data['ç¼–å·']) {
                                    newNode['ç¼–å·'] = result.data.data['ç¼–å·'];
                                    console.log('å·²ä½¿ç”¨SDKè¿”å›çš„ç¼–å·:', result.data.data['ç¼–å·']);
                                } else {
                                    throw new Error('SDKæœªè¿”å›èŠ‚ç‚¹ç¼–å·');
                                }

                                flatList.value.push(newNode);
                                closeModal();

                                // Auto select new node
                                nextTick(() => {
                                    handleSelect(newNode);
                                });

                                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                                if (typeof window.showNotification === 'function') {
                                    window.showNotification('æˆåŠŸ', 'èŠ‚ç‚¹æ–°å»ºæˆåŠŸ', 'success');
                                }
                            } else {
                                throw new Error(result?.msg || 'ä¿å­˜å¤±è´¥');
                            }
                        } catch (error) {
                            console.error('SDKä¿å­˜æ–°å»ºèŠ‚ç‚¹å¤±è´¥:', error);
                            if (typeof window.showNotification === 'function') {
                                window.showNotification('é”™è¯¯', 'æ–°å»ºèŠ‚ç‚¹å¤±è´¥ï¼š' + error.message, 'error');
                            } else {
                                alert('æ–°å»ºèŠ‚ç‚¹å¤±è´¥ï¼š' + error.message);
                            }
                        }

                    } else {
                        // Edit Logic - Call SDK to save edited node
                        try {
                            console.log('è°ƒç”¨SDKä¿å­˜ç¼–è¾‘èŠ‚ç‚¹:', {
                                nodeId: modalForm.value.id,
                                nodeName: modalForm.value.name,
                                nodeType: modalForm.value.type,
                                parentCode: modalForm.value.parentCode
                            });

                            // è°ƒç”¨SDKä¿å­˜æ¥å£ï¼ˆç¼–è¾‘æ—¶ä¼ ç¼–å·ï¼‰
                            const result = await callSDKSaveNode({
                                nodeId: modalForm.value.id,
                                nodeName: modalForm.value.name,
                                nodeType: modalForm.value.type,
                                parentCode: modalForm.value.parentCode
                            });

                            if (result && result.state === '200') {
                                console.log('SDKä¿å­˜æˆåŠŸï¼Œè¿”å›ç»“æœ:', result);

                                // æ›´æ–°æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯
                                const index = flatList.value.findIndex(n => n['ç¼–å·'] === modalForm.value.id);
                                if (index !== -1) {
                                    flatList.value[index]['èŠ‚ç‚¹å'] = modalForm.value.name;
                                    flatList.value[index]['èŠ‚ç‚¹ç±»å‹'] = modalForm.value.type;
                                }

                                closeModal();

                                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                                if (typeof window.showNotification === 'function') {
                                    window.showNotification('æˆåŠŸ', 'èŠ‚ç‚¹æ›´æ–°æˆåŠŸ', 'success');
                                } else {
                                    alert('æ›´æ–°æˆåŠŸ');
                                }
                            } else {
                                throw new Error(result?.msg || 'ä¿å­˜å¤±è´¥');
                            }
                        } catch (error) {
                            console.error('SDKä¿å­˜ç¼–è¾‘èŠ‚ç‚¹å¤±è´¥:', error);
                            if (typeof window.showNotification === 'function') {
                                window.showNotification('é”™è¯¯', 'ç¼–è¾‘èŠ‚ç‚¹å¤±è´¥ï¼š' + error.message, 'error');
                            } else {
                                alert('ç¼–è¾‘èŠ‚ç‚¹å¤±è´¥ï¼š' + error.message);
                            }
                        }
                    }
                };

                const handleDelete = (node) => {
                    // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æ›¿ä»£åŸç”Ÿconfirm
                    const performDelete = async () => {
                        try {
                            // æ”¶é›†æ‰€æœ‰è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å­èŠ‚ç‚¹ï¼‰
                            const rowCodes = [];
                            const deleteRecursively = (uuid) => {
                                const children = flatList.value.filter(n => n['parentCode'] === uuid);
                                children.forEach(child => deleteRecursively(child['ç¼–å·']));
                                rowCodes.push(uuid);
                            };

                            deleteRecursively(node['ç¼–å·']);

                            console.log('è°ƒç”¨SDKåˆ é™¤èŠ‚ç‚¹ï¼Œå‚æ•°:', {
                                panelCode: "IML_00001",
                                buttonName: "åˆ é™¤",
                                buttonParam: {
                                    rowCodes: rowCodes
                                }
                            });

                            // è°ƒç”¨SDKåˆ é™¤æ¥å£
                            const result = await sdk.api.callButton({
                                "panelCode": "IML_00001",
                                "buttonName": "åˆ é™¤",
                                "buttonParam": {
                                    "rowCodes": rowCodes
                                }
                            });

                            console.log('SDKåˆ é™¤è¿”å›ç»“æœ:', result);

                            if (result && result.state === '200') {
                                console.log('SDKåˆ é™¤æˆåŠŸ');

                                // ä»æœ¬åœ°åˆ—è¡¨ä¸­åˆ é™¤èŠ‚ç‚¹
                                rowCodes.forEach(uuid => {
                                    const index = flatList.value.findIndex(n => n['ç¼–å·'] === uuid);
                                    if (index !== -1) {
                                        flatList.value.splice(index, 1);
                                    }
                                });

                                // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                                if (selectedNodeId.value === node['ç¼–å·']) {
                                    selectedNodeId.value = null;
                                    rightPanelView.value = 'details';
                                }

                                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                                if (typeof window.showNotification === 'function') {
                                    window.showNotification('æˆåŠŸ', 'èŠ‚ç‚¹åˆ é™¤æˆåŠŸ', 'success');
                                } else {
                                    alert('åˆ é™¤æˆåŠŸ');
                                }
                            } else {
                                throw new Error(result?.msg || 'åˆ é™¤å¤±è´¥');
                            }
                        } catch (error) {
                            console.error('SDKåˆ é™¤èŠ‚ç‚¹å¤±è´¥:', error);
                            if (typeof window.showNotification === 'function') {
                                window.showNotification('é”™è¯¯', 'åˆ é™¤èŠ‚ç‚¹å¤±è´¥ï¼š' + error.message, 'error');
                            } else {
                                alert('åˆ é™¤èŠ‚ç‚¹å¤±è´¥ï¼š' + error.message);
                            }
                        }
                    };

                    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    showConfirm(
                        'åˆ é™¤ç¡®è®¤',
                        `ç¡®å®šè¦åˆ é™¤ "${node['èŠ‚ç‚¹å']}" åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹å—ï¼Ÿ`,
                        performDelete
                    );
                };

                const resetData = () => {
                    if (confirm("ç¡®å®šé‡ç½®ä¸ºåˆå§‹æ•°æ®å—ï¼Ÿ")) {
                        loadData();
                        selectedNodeId.value = null;
                        rightPanelView.value = 'details';
                    }
                };

                // åˆ·æ–°æ ‘ï¼ˆè°ƒç”¨ SDK æ‹‰å–æœ€æ–°æ•°æ®ï¼Œå¹¶æ¸…é™¤å½“å‰é€‰ä¸­ï¼‰
                const refreshTree = async () => {
                    if (refreshLoading.value) return;
                    try {
                        refreshLoading.value = true;
                        console.log('æ­£åœ¨åˆ·æ–°ç›®å½•æ ‘...');
                        await loadData();
                        selectedNodeId.value = null;
                        rightPanelView.value = 'details';
                        // ä¿æŒé—ªçƒæ•ˆæœä¸€æ®µæ—¶é—´
                        setTimeout(() => {
                            refreshLoading.value = false;
                            console.log('ç›®å½•æ ‘åˆ·æ–°å®Œæˆ');
                        }, 600);
                    } catch (e) {
                        refreshLoading.value = false;
                        console.error('åˆ·æ–°ç›®å½•æ ‘å¤±è´¥:', e);
                    }
                };

                const getNodeIcon = (type) => {
                    if (type === 'ç›®å½•') return 'fa-regular fa-folder-open';
                    if (type === 'æŒ‡æ ‡æŠ¥è¡¨') return 'fa-solid fa-chart-pie';
                    if (type === 'æ˜ç»†æŠ¥è¡¨') return 'fa-solid fa-table-list';
                    return 'fa-regular fa-file';
                };

                const getNodeIconBg = (type) => {
                    if (type === 'ç›®å½•') return 'bg-yellow-500';
                    if (type === 'æŒ‡æ ‡æŠ¥è¡¨') return 'bg-purple-500';
                    if (type === 'æ˜ç»†æŠ¥è¡¨') return 'bg-green-500';
                    return 'bg-gray-400';
                };

                onMounted(async () => {
                    await loadData();
                });

                return {
                    treeData,
                    selectedNodeId,
                    selectedNode,
                    dataSourceType,
                    // View State
                    rightPanelView,
                    iframeRef,
                    // Modal State
                    showModal,
                    modalMode,
                    modalForm,
                    nameInput,
                    refreshLoading,
                    // Confirm Dialog State
                    showConfirmDialog,
                    confirmDialogData,
                    // Actions
                    handleSelect,
                    switchToDetails,
                    switchToIframe,
                    showConfirm,
                    confirmAction,
                    cancelAction,
                    refreshTree,
                    openAddRootModal,
                    openAddChildModal,
                    openEditModal,
                    closeModal,
                    confirmModal,
                    handleDelete,
                    resetData,
                    getNodeIcon,
                    getNodeIconBg,
                    onIframeLoad,
                    getDesignPageUrl,
                    getDesignPageName
                };
            }
        }).mount('#app');
    </script>
</body>

</html>