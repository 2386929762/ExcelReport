<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥è¡¨ç¼–è¾‘æ ‘</title>
    <script src="js/tailwindcss.min.js"></script>
    <script src="js/vue.global.prod.js"></script>
    <link href="css/font-awesome-6.5.1-all.min.css" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"> -->
    <link href="css/inter-font.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .tree-line {
            position: absolute;
            left: 11px;
            top: 24px;
            bottom: 0;
            width: 1px;
            background-color: #e2e8f0;
            z-index: 0;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Modal Transition */
        .modal-enter-active,
        .modal-leave-active {
            transition: opacity 0.3s ease;
        }

        .modal-enter-from,
        .modal-leave-to {
            opacity: 0;
        }

        /* é¿å… Vue æŒ‚è½½å‰æ¨¡æ¿å ä½å†…å®¹é—ªçƒ (v-cloak) */
        [v-cloak] {
            display: none !important;
        }

        /* åˆ·æ–°é—ªçƒåŠ¨ç”» */
        @keyframes flash-bg {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.0);
            }

            50% {
                box-shadow: 0 0 12px 4px rgba(34, 197, 94, 0.12);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.0);
            }
        }

        .refresh-flash {
            animation: flash-bg 0.6s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden flex flex-col">

    <div id="app" v-cloak class="h-full flex flex-col relative">

        <!-- <header class="bg-white border-b border-gray-200 h-16 flex items-center px-6 shadow-sm z-10 justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-md">
                    <i class="fa-solid fa-network-wired"></i>
                </div>
                <h1 class="text-xl font-semibold text-gray-800 tracking-tight">æŠ¥è¡¨èŠ‚ç‚¹ç®¡ç†ç³»ç»Ÿ</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm text-gray-500 bg-gray-50 px-3 py-1 rounded-full border border-gray-200">
                    <span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-2"></span>
                    æ•°æ®æº: {{ dataSourceType }}
                </div>
                <button @click="resetData" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                    <i class="fa-solid fa-rotate-right mr-1"></i> é‡ç½®æ•°æ®
                </button>
            </div>
        </header> -->

        <main class="flex-1 flex overflow-hidden">

            <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-0">
                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">æŠ¥è¡¨ç›®å½•</span>
                    <div class="flex items-center gap-2">
                        <button @click="openDirModal('add-root')"
                            class="text-xs bg-white border border-gray-200 hover:border-blue-500 hover:text-blue-600 text-gray-600 px-2 py-1 rounded transition-colors shadow-sm"
                            title="æ–°å¢æ ¹ç›®å½•">
                            <i class="fa-solid fa-folder-plus"></i>
                        </button>
                        <button @click="refreshTree" :disabled="refreshLoading"
                            class="px-2 py-1 text-xs rounded border transition-colors flex items-center gap-1"
                            :class="refreshLoading ? 'bg-gray-100 text-gray-500 border-gray-200 cursor-not-allowed' : 'bg-white text-gray-700 border-gray-200 hover:border-blue-400 hover:text-blue-600'"
                            title="åˆ·æ–°ç›®å½•">
                            <i :class="refreshLoading ? 'fa-solid fa-spinner fa-spin' : 'fa-solid fa-rotate-right'"></i>
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto">
                    <div v-if="allDirectories.length > 0" class="flex flex-col">
                        <div v-for="dir in allDirectories" :key="dir['ç¼–å·']"
                            class="group relative flex items-center gap-2 px-4 py-3 border-b border-gray-100 transition-all hover:bg-gray-50"
                            :class="dir['ç¼–å·'] === selectedDirId ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''">
                            <button @click="switchDirectory(dir)"
                                class="flex items-center gap-2 flex-1 text-left">
                                <i class="fa-regular fa-folder text-yellow-500 text-sm"></i>
                                <span class="text-sm font-medium truncate" 
                                    :class="dir['ç¼–å·'] === selectedDirId ? 'text-blue-700' : 'text-gray-700'">
                                    {{ dir['èŠ‚ç‚¹å'] }}
                                </span>
                                <span v-if="getDirectoryTabCount(dir['ç¼–å·']) > 0" 
                                    class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">
                                    {{ getDirectoryTabCount(dir['ç¼–å·']) }}
                                </span>
                            </button>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click.stop="openDirModal('rename', dir)"
                                    class="p-1.5 text-xs rounded border border-gray-200 text-blue-600 hover:bg-blue-50 hover:border-blue-400 transition-colors"
                                    title="ç¼–è¾‘ç›®å½•">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button @click.stop="deleteDirectory(dir)"
                                    class="p-1.5 text-xs rounded border border-gray-200 text-red-600 hover:bg-red-50 hover:border-red-400 transition-colors"
                                    title="åˆ é™¤ç›®å½•">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-else class="flex flex-col items-center justify-center h-full text-gray-400 text-sm">
                        <i class="fa-solid fa-folder-open text-3xl mb-2 opacity-50"></i>
                        <p>æš‚æ— ç›®å½•</p>
                    </div>
                </div>
            </aside>

            <section class="flex-1 bg-white relative overflow-hidden flex flex-col">

                <!-- Tabæ ‡ç­¾æ  -->
                <div class="flex items-center gap-1 px-2 py-2 border-b border-gray-200 bg-gray-50 overflow-x-auto shrink-0">
                    <button v-for="tab in allTabs" :key="tab.id"
                        @click="switchTab(tab.id)"
                        class="flex items-center gap-2 px-3 py-1.5 rounded-t border transition-all text-sm whitespace-nowrap"
                        :class="tab.id === currentActiveTab ? 'bg-white border-gray-200 border-b-white -mb-px text-gray-800 font-medium' : 'bg-gray-100 border-transparent text-gray-600 hover:bg-gray-200'">
                        <i v-if="tab.isListTab" class="fa-solid fa-list text-xs"></i>
                        <i v-else class="fa-regular fa-file-lines text-xs"></i>
                        <span class="truncate max-w-[120px]">{{ tab.name }}</span>
                        <i v-if="!tab.isListTab" @click.stop="closeTab(tab.id)" 
                            class="fa-solid fa-xmark text-xs hover:text-red-600 hover:bg-red-50 rounded p-1"></i>
                    </button>
                </div>

                <!-- Tabå†…å®¹åŒº -->
                <div class="flex-1 overflow-hidden relative">
                    <!-- æŠ¥è¡¨åˆ—è¡¨Tabå†…å®¹ -->
                    <div v-show="currentActiveTab === 'list'" class="h-full flex flex-col bg-white">
                        <div class="h-12 bg-gray-50 border-b border-gray-100 flex items-center justify-between px-6 shrink-0">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="text-gray-500">å½“å‰ç›®å½•ï¼š</span>
                                <span v-if="selectedDir" class="text-gray-800 font-medium">{{ selectedDir['èŠ‚ç‚¹å'] }}</span>
                                <span v-else class="text-gray-400">è¯·é€‰æ‹©å·¦ä¾§ç›®å½•</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                    <input v-model="searchKeyword" @input="handleSearch" type="text" placeholder="æœç´¢æŠ¥è¡¨åç§°"
                                        class="pl-8 pr-3 py-1.5 text-sm border rounded-md bg-gray-50 focus:bg-white focus:border-blue-400 focus:outline-none"
                                        :disabled="!selectedDirId">
                                </div>
                                <button @click="refreshReports" :disabled="!selectedDirId || listLoading"
                                    class="px-2 py-1.5 text-xs rounded border transition-colors flex items-center gap-1"
                                    :class="!selectedDirId || listLoading ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-white text-gray-700 border-gray-200 hover:border-blue-400 hover:text-blue-600'">
                                    <i :class="listLoading ? 'fa-solid fa-spinner fa-spin' : 'fa-solid fa-arrows-rotate'"></i>
                                </button>
                            </div>
                        </div>

                        <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between bg-white">
                            <button @click="openReportModal('add')" :disabled="!selectedDirId"
                                class="px-3 py-2 text-xs rounded border transition-colors flex items-center gap-1"
                                :class="!selectedDirId ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100'">
                                <i class="fa-solid fa-plus"></i>
                                <span>æ–°å¢æŠ¥è¡¨</span>
                            </button>
                        </div>

                        <div class="flex-1 overflow-y-auto">
                            <table v-if="selectedDirId" class="min-w-full text-sm">
                                <thead class="bg-gray-50 text-gray-600 sticky top-0">
                                    <tr>
                                        <th class="text-left px-4 py-2 w-12">åºå·</th>
                                        <th class="text-left px-4 py-2">æŠ¥è¡¨åç§°</th>
                                        <th class="text-left px-4 py-2 w-32">ç¼–å·</th>
                                        <th class="text-left px-4 py-2 w-24">ç±»å‹</th>
                                        <th class="text-center px-4 py-2 w-32">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(report, index) in paginatedReports" :key="report['ç¼–å·']"
                                        @click="openReportTab(report)"
                                        class="border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors">
                                        <td class="px-4 py-2 text-gray-500">{{ (currentPage - 1) * pageSize + index + 1 }}</td>
                                        <td class="px-4 py-2 text-gray-800 font-medium truncate">{{ report['èŠ‚ç‚¹å'] }}</td>
                                        <td class="px-4 py-2 text-gray-600 text-xs">{{ report['ç¼–å·'] }}</td>
                                        <td class="px-4 py-2 text-gray-600 text-xs">{{ report['èŠ‚ç‚¹ç±»å‹'] || 'æ˜ç»†æŠ¥è¡¨' }}</td>
                                        <td class="px-4 py-2">
                                            <div class="flex items-center justify-center gap-2">
                                                <button @click.stop="selectedReportId = report['ç¼–å·']; openReportModal('edit')"
                                                    class="px-2 py-1 text-xs rounded border border-gray-200 text-blue-600 hover:bg-blue-50 hover:border-blue-400 transition-colors"
                                                    title="ç¼–è¾‘åç§°">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button @click.stop="selectedReportId = report['ç¼–å·']; deleteReport()"
                                                    class="px-2 py-1 text-xs rounded border border-gray-200 text-red-600 hover:bg-red-50 hover:border-red-400 transition-colors"
                                                    title="åˆ é™¤">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr v-if="!listLoading && paginatedReports.length === 0">
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-400 text-sm">æš‚æ— æŠ¥è¡¨</td>
                                    </tr>
                                    <tr v-if="listLoading">
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-400 text-sm">åŠ è½½ä¸­...</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div v-else class="h-full flex items-center justify-center text-gray-400 text-sm">
                                è¯·é€‰æ‹©å·¦ä¾§ç›®å½•åæŸ¥çœ‹æŠ¥è¡¨åˆ—è¡¨
                            </div>
                        </div>

                        <div v-if="selectedDirId" class="px-4 py-2 border-t border-gray-100 flex items-center justify-between bg-gray-50 shrink-0">
                            <div class="text-xs text-gray-500">å…± {{ totalReports }} æ¡ | ç¬¬ {{ currentPage }} / {{ totalPages }} é¡µ</div>
                            <div class="flex items-center gap-2">
                                <button @click="prevPage" :disabled="currentPage === 1"
                                    class="px-2 py-1 text-xs rounded border transition-colors"
                                    :class="currentPage === 1 ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-white text-gray-700 border-gray-200 hover:border-blue-400 hover:text-blue-600'">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>
                                <button @click="nextPage" :disabled="currentPage === totalPages || totalPages === 0"
                                    class="px-2 py-1 text-xs rounded border transition-colors"
                                    :class="(currentPage === totalPages || totalPages === 0) ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : 'bg-white text-gray-700 border-gray-200 hover:border-blue-400 hover:text-blue-600'">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                                <select v-model.number="pageSize" @change="handlePageSizeChange"
                                    class="text-xs border rounded px-2 py-1 bg-white">
                                    <option :value="10">10/é¡µ</option>
                                    <option :value="20">20/é¡µ</option>
                                    <option :value="50">50/é¡µ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘Tabå†…å®¹ (iframes) -->
                    <iframe v-for="tab in editorTabs" :key="tab.id"
                        v-show="tab.id === currentActiveTab"
                        :src="tab.url"
                        :ref="el => { if (el) iframeRefs[tab.id] = el }"
                        @load="handleIframeLoad(tab)"
                        class="w-full h-full border-0"
                        :title="tab.name"></iframe>
                </div>
            </section>
        </main>

        <!-- ç›®å½•å¼¹çª— -->
        <div v-if="showDirModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-gray-800">
                        {{ dirModalMode === 'rename' ? 'é‡å‘½åç›®å½•' : 'æ–°å¢æ ¹ç›®å½•' }}
                    </h3>
                    <button @click="showDirModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="p-4 space-y-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">ç›®å½•åç§°</label>
                        <input v-model="dirForm.name" type="text" placeholder="è¯·è¾“å…¥ç›®å½•åç§°"
                            class="w-full border rounded px-3 py-2 text-sm focus:border-blue-400 focus:outline-none bg-gray-50">
                    </div>
                    <div v-if="dirModalMode === 'rename'" class="text-xs text-gray-500 bg-gray-50 border rounded px-3 py-2">
                        å½“å‰ç›®å½•ï¼š{{ selectedDir ? selectedDir['èŠ‚ç‚¹å'] : '' }}
                    </div>
                </div>
                <div class="px-4 py-3 border-t border-gray-100 flex justify-end gap-2">
                    <button @click="showDirModal = false" class="px-3 py-2 text-xs rounded border text-gray-600 bg-white hover:border-gray-300">å–æ¶ˆ</button>
                    <button @click="submitDirModal" class="px-3 py-2 text-xs rounded bg-blue-600 text-white hover:bg-blue-700">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <!-- æŠ¥è¡¨å¼¹çª— -->
        <div v-if="showReportModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-sm border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-gray-800">
                        {{ reportModalMode === 'edit' ? 'ç¼–è¾‘æŠ¥è¡¨' : 'æ–°å¢æŠ¥è¡¨' }}
                    </h3>
                    <button @click="showReportModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="p-4 space-y-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">æŠ¥è¡¨åç§°</label>
                        <input v-model="reportForm.name" type="text" placeholder="è¯·è¾“å…¥æŠ¥è¡¨åç§°"
                            class="w-full border rounded px-3 py-2 text-sm focus:border-blue-400 focus:outline-none bg-gray-50">
                    </div>
                    <div class="text-xs text-gray-500 bg-gray-50 border rounded px-3 py-2">
                        å½’å±ç›®å½•ï¼š{{ selectedDir ? selectedDir['èŠ‚ç‚¹å'] : 'æœªé€‰æ‹©' }}
                    </div>
                </div>
                <div class="px-4 py-3 border-t border-gray-100 flex justify-end gap-2">
                    <button @click="showReportModal = false" class="px-3 py-2 text-xs rounded border text-gray-600 bg-white hover:border-gray-300">å–æ¶ˆ</button>
                    <button @click="submitReportModal" class="px-3 py-2 text-xs rounded bg-blue-600 text-white hover:bg-blue-700">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <transition name="modal">
            <div v-if="showModal"
                class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm">
                <div
                    class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-800">
                            {{ modalMode === 'add' ? 'æ–°å»ºèŠ‚ç‚¹' : 'ç¼–è¾‘èŠ‚ç‚¹' }}
                        </h3>
                        <button @click="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <div class="p-6">
                        <form @submit.prevent="confirmModal" id="nodeForm">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">èŠ‚ç‚¹åç§° <span
                                            class="text-red-500">*</span></label>
                                    <input v-model="modalForm.name" type="text" required
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2.5 outline-none transition-all"
                                        placeholder="è¯·è¾“å…¥åç§°" ref="nameInput">
                                </div>

                                <div v-if="modalMode === 'edit'">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ç¼–å·/ID <span
                                            class="text-gray-400 text-xs font-normal">(åªè¯»)</span></label>
                                    <input v-model="modalForm.id" type="text" disabled
                                        class="w-full rounded-md border-gray-300 shadow-sm sm:text-sm border p-2.5 outline-none bg-gray-100 text-gray-500 cursor-not-allowed">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">èŠ‚ç‚¹ç±»å‹ <span
                                            class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <select v-model="modalForm.type" :disabled="modalMode === 'edit'"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border p-2.5 outline-none bg-white appearance-none disabled:bg-gray-100 disabled:text-gray-500">
                                            <option value="ç›®å½•">ğŸ“‚ ç›®å½• (Directory)</option>
                                            <!-- <option value="æŒ‡æ ‡æŠ¥è¡¨">ğŸ“Š æŒ‡æ ‡æŠ¥è¡¨ (Report)</option> -->
                                            <option value="æ˜ç»†æŠ¥è¡¨">ğŸ“‘ æ˜ç»†æŠ¥è¡¨ (Detail)</option>
                                        </select>
                                        <div
                                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <i class="fa-solid fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>
                                    <p v-if="modalMode === 'edit'" class="text-xs text-yellow-600 mt-1">
                                        <i class="fa-solid fa-info-circle"></i> ç¼–è¾‘æ¨¡å¼ä¸‹æ— æ³•ä¿®æ”¹èŠ‚ç‚¹ç±»å‹
                                    </p>
                                </div>

                                <div v-if="modalMode === 'add'"
                                    class="text-xs text-gray-500 pt-2 border-t border-gray-100 mt-4">
                                    <span class="font-semibold">çˆ¶èŠ‚ç‚¹:</span>
                                    {{ modalForm.parentName || 'æ ¹èŠ‚ç‚¹ (Root)' }}
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end gap-3">
                        <button type="button" @click="closeModal"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" form="nodeForm"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none transition-colors">
                            ç¡®è®¤ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>

            <!-- Confirm Dialog -->
            <div v-if="showConfirmDialog"
                class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800">
                            {{ confirmDialogData.title }}
                        </h3>
                    </div>

                    <div class="p-6">
                        <p class="text-gray-700 text-base">
                            {{ confirmDialogData.message }}
                        </p>
                    </div>

                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end gap-3">
                        <button @click="cancelAction"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button @click="confirmAction"
                            class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-lg shadow-sm hover:bg-red-700 focus:outline-none transition-colors">
                            ç¡®è®¤åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script type="text/x-template" id="tree-node-template">
        <div class="relative pl-4 select-none">
            <div v-if="depth > 0" class="tree-line"></div>
            
            <div 
                class="group relative flex items-center justify-between p-2 rounded-md cursor-pointer transition-all duration-200 border border-transparent hover:bg-gray-100 mb-1"
                :class="{'bg-blue-50 border-blue-100': isSelected}"
                @click.stop="handleClick"
            >
                <div class="flex items-center gap-2 overflow-hidden">
                    <span 
                        v-if="isFolder" 
                        @click.stop="toggle" 
                        class="w-5 h-5 flex items-center justify-center rounded hover:bg-gray-200 text-gray-400 transition-colors"
                    >
                        <i :class="isOpen ? 'fa-solid fa-caret-down text-gray-600' : 'fa-solid fa-caret-right'"></i>
                    </span>
                    <span v-else class="w-5 h-5"></span>

                    <i :class="[getIconClass, isSelected ? 'text-blue-600' : 'text-gray-500']" class="text-sm"></i>
                    
                    <span class="text-sm font-medium truncate" :class="isSelected ? 'text-blue-700' : 'text-gray-700'">
                        {{ node['èŠ‚ç‚¹å'] }}
                    </span>
                </div>
            </div>

            <transition name="fade">
                <div v-if="isFolder && isOpen" class="relative">
                    <tree-node 
                        v-for="child in node.children" 
                        :key="child['ç¼–å·']" 
                        :node="child"
                        :depth="depth + 1"
                        :selected-id="selectedId"
                        @select="$emit('select', $event)"
                        @add="$emit('add', $event)"
                        @edit="$emit('edit', $event)"
                        @delete="$emit('delete', $event)"
                    ></tree-node>
                </div>
            </transition>
        </div>
    </script>

    <!-- SDK Preload - Must be first -->
    <script src="js/preload.js" devSdkUrl="https://demo.kwaidoo.com/zbyth/process/wp-core/api/getPanelXSdk"></script>
    <script src="js/sdkConfig.js"></script>
    <script>
        // SDKè„šæœ¬æ— æ³•ç¦»çº¿è®¿é—®ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤URLè¿›è¡Œå¼€å‘æµ‹è¯•
        const { createApp, ref, computed, onMounted } = Vue;

        let sdk = null;
        const LIST_PANEL_CODE = 'OctoCM_BDYTH_IML_00001';
        const BUTTON_PANEL_CODE = window.SDK_CONFIG_SETTINGS?.saveButton?.panelCode || 'IML_00001';

        // --- Default Mock Data ---
        const DEFAULT_DATA = [
            { "ç¼–å·": "000", "èŠ‚ç‚¹å": "çˆ¶èŠ‚ç‚¹", "èŠ‚ç‚¹ç±»å‹": "ç›®å½•" },
            { "ç¼–å·": "001", "èŠ‚ç‚¹å": "æ ·ä¾‹æŠ¥è¡¨A", "èŠ‚ç‚¹ç±»å‹": "æ˜ç»†æŠ¥è¡¨", "parentCode": "000" },
            { "ç¼–å·": "002", "èŠ‚ç‚¹å": "æ ·ä¾‹æŠ¥è¡¨B", "èŠ‚ç‚¹ç±»å‹": "æ˜ç»†æŠ¥è¡¨", "parentCode": "000" }
        ];

        async function callSDKSaveNode(nodeInfo) {
            try {
                if (!sdk) {
                    sdk = await window.initializeSDK();
                }
                if (!sdk || !sdk.api) {
                    throw new Error('SDKåˆå§‹åŒ–å¤±è´¥æˆ–ä¸å¯ç”¨');
                }

                const saveButtonConfig = window.SDK_CONFIG_SETTINGS.saveButton;
                const formData = {
                    "èŠ‚ç‚¹å": nodeInfo.nodeName,
                    "èŠ‚ç‚¹ç±»å‹": nodeInfo.nodeType || 'æ˜ç»†æŠ¥è¡¨'
                };

                if (nodeInfo.parentCode) {
                    formData.parentCode = nodeInfo.parentCode;
                }
                if (nodeInfo.nodeId) {
                    formData['ç¼–å·'] = nodeInfo.nodeId;
                }

                const result = await sdk.api.callButton({
                    panelCode: saveButtonConfig.panelCode,
                    buttonName: saveButtonConfig.buttonName,
                    formData
                });

                return result;
            } catch (error) {
                console.error('è°ƒç”¨SDKä¿å­˜èŠ‚ç‚¹å¤±è´¥:', error);
                throw error;
            }
        }

        const TreeNode = {
            template: '#tree-node-template',
            name: 'TreeNode',
            props: ['node', 'selectedId', 'depth'],
            emits: ['select'],
            setup(props, { emit }) {
                const isOpen = ref(props.depth === 0);
                const isFolder = computed(() => props.node['èŠ‚ç‚¹ç±»å‹'] === 'ç›®å½•');
                const isSelected = computed(() => props.node['ç¼–å·'] === props.selectedId);
                const getIconClass = computed(() => isOpen.value ? 'fa-regular fa-folder-open text-yellow-500' : 'fa-regular fa-folder text-yellow-500');
                const toggle = () => { if (isFolder.value) isOpen.value = !isOpen.value; };
                const handleClick = () => { emit('select', props.node); toggle(); };
                return { isOpen, isFolder, isSelected, getIconClass, toggle, handleClick };
            }
        };

        createApp({
            setup() {
                const flatList = ref([]);
                const selectedDirId = ref(null);
                const refreshLoading = ref(false);

                const reportList = ref([]);
                const selectedReportId = ref(null);
                const listLoading = ref(false);

                const searchKeyword = ref('');
                const currentPage = ref(1);
                const pageSize = ref(10);
                let searchDebounceTimer = null;

                const showDirModal = ref(false);
                const dirModalMode = ref('add-root');
                const dirForm = ref({ name: '', id: '', parentCode: '' });

                const showReportModal = ref(false);
                const reportModalMode = ref('add');
                const reportForm = ref({ name: '', id: '' });

                // Tabç®¡ç†ï¼š{ [dirId]: { activeTab: string, tabs: [{id, name, url, nodeCode}] } }
                const dirTabsMap = ref({});
                
                // iframeå¼•ç”¨æ˜ å°„
                const iframeRefs = ref({});

                const allDirectories = computed(() => {
                    // åªæ˜¾ç¤ºç¬¬ä¸€å±‚ç›®å½•ï¼ˆæ²¡æœ‰parentCodeçš„ç›®å½•ï¼‰
                    return flatList.value.filter(n => n['èŠ‚ç‚¹ç±»å‹'] === 'ç›®å½•' && !n.parentCode);
                });

                const treeData = computed(() => {
                    const directories = flatList.value.filter(n => n['èŠ‚ç‚¹ç±»å‹'] === 'ç›®å½•');
                    const map = {};
                    const roots = [];
                    directories.forEach(node => { node.children = []; map[node['ç¼–å·']] = node; });
                    directories.forEach(node => {
                        if (node['parentCode'] && map[node['parentCode']]) {
                            map[node['parentCode']].children.push(node);
                        } else {
                            roots.push(node);
                        }
                    });
                    return roots;
                });

                const selectedDir = computed(() => flatList.value.find(n => n['ç¼–å·'] === selectedDirId.value));

                // å› ä¸ºæ”¹ä¸ºæœåŠ¡ç«¯åˆ†é¡µï¼ŒreportListç›´æ¥å°±æ˜¯å½“å‰é¡µçš„æ•°æ®
                const totalReports = ref(0);
                const totalPages = computed(() => {
                    const pages = Math.ceil(totalReports.value / pageSize.value);
                    return pages > 0 ? pages : 1;
                });
                const paginatedReports = computed(() => {
                    // ç›´æ¥è¿”å›reportListï¼Œå› ä¸ºå·²ç»æ˜¯åˆ†é¡µåçš„æ•°æ®
                    return reportList.value;
                });

                const currentTabs = computed(() => {
                    if (!selectedDirId.value) return [];
                    return dirTabsMap.value[selectedDirId.value]?.tabs || [];
                });

                const currentActiveTab = computed(() => {
                    if (!selectedDirId.value) return null;
                    return dirTabsMap.value[selectedDirId.value]?.activeTab || null;
                });

                // æ‰€æœ‰tabsåŒ…æ‹¬å›ºå®šçš„åˆ—è¡¨tabå’Œç¼–è¾‘tabs
                const allTabs = computed(() => {
                    const listTab = {
                        id: 'list',
                        name: selectedDir.value ? selectedDir.value['èŠ‚ç‚¹å'] : 'æŠ¥è¡¨åˆ—è¡¨',
                        isListTab: true
                    };
                    return [listTab, ...currentTabs.value];
                });

                // ä»…ç¼–è¾‘tabsï¼ˆç”¨äºiframeæ¸²æŸ“ï¼‰
                const editorTabs = computed(() => {
                    return currentTabs.value.filter(t => !t.isListTab);
                });

                const getDirectoryTabCount = (dirId) => {
                    return dirTabsMap.value[dirId]?.tabs?.length || 0;
                };

                const resetToFirstPage = () => { 
                    currentPage.value = 1; 
                    // ä»…é‡ç½®é¡µç ï¼Œä¸å†è‡ªåŠ¨åŠ è½½ï¼Œç”±refreshReportsæŒ‰é’®è§¦å‘åŠ è½½
                };
                
                // æœç´¢æ—¶ä½¿ç”¨é˜²æŠ–
                const handleSearch = () => {
                    currentPage.value = 1;
                    if (searchDebounceTimer) {
                        clearTimeout(searchDebounceTimer);
                    }
                    searchDebounceTimer = setTimeout(() => {
                        if (selectedDirId.value) {
                            loadReportsForDir(selectedDirId.value);
                        }
                    }, 500);
                };
                
                // æ”¹å˜é¡µé¢å¤§å°æ—¶é‡ç½®åˆ°ç¬¬ä¸€é¡µå¹¶ç«‹å³æŸ¥è¯¢
                const handlePageSizeChange = () => {
                    currentPage.value = 1;
                    if (selectedDirId.value) {
                        loadReportsForDir(selectedDirId.value);
                    }
                };
                
                const prevPage = () => { 
                    if (currentPage.value > 1) {
                        currentPage.value -= 1;
                        if (selectedDirId.value) {
                            loadReportsForDir(selectedDirId.value);
                        }
                    }
                };
                const nextPage = () => { 
                    if (currentPage.value < totalPages.value) {
                        currentPage.value += 1;
                        if (selectedDirId.value) {
                            loadReportsForDir(selectedDirId.value);
                        }
                    }
                };

                const loadData = async () => {
                    let finalData = [];
                    try {
                        if (!sdk) sdk = await window.initializeSDK();
                        if (sdk && sdk.api) {
                            const res = await sdk.api.queryFormDataList({
                                panelCode: LIST_PANEL_CODE,
                                pageNo: 1,
                                pageSize: 500
                            });
                            if (res?.data?.list) {
                                finalData = res.data.list;
                            }
                        }
                    } catch (e) {
                        console.error('åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', e);
                    }
                    if (!finalData || finalData.length === 0) {
                        finalData = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    }
                    flatList.value = finalData;
                };

                const loadReportsForDir = async (dirId) => {
                    if (!dirId) return;
                    if (listLoading.value) return; // é˜²æ­¢é‡å¤åŠ è½½
                    listLoading.value = true;
                    selectedReportId.value = null;
                    try {
                        let reports = [];
                        let total = 0;
                        if (!sdk) sdk = await window.initializeSDK();
                        if (sdk && sdk.api) {
                            const params = {
                                panelCode: LIST_PANEL_CODE,
                                condition: {
                                    parentCode: dirId,
                                    "èŠ‚ç‚¹ç±»å‹": "æ˜ç»†æŠ¥è¡¨"
                                },
                                keyword: searchKeyword.value.trim(),
                                pageNo: currentPage.value,
                                pageSize: pageSize.value
                            };
                            const res = await sdk.api.queryFormDataList(params);
                            if (res?.data?.list) {
                                reports = res.data.list;
                                total = res.data.totalSize || reports.length;
                            }
                        }

                        if (!reports || reports.length === 0) {
                            reports = flatList.value.filter(n => 
                                n['parentCode'] === dirId && 
                                n['èŠ‚ç‚¹ç±»å‹'] === 'æ˜ç»†æŠ¥è¡¨'
                            );
                            total = reports.length;
                        }

                        reportList.value = reports;
                        totalReports.value = total;
                    } catch (e) {
                        console.error('åŠ è½½æŠ¥è¡¨å¤±è´¥:', e);
                    } finally {
                        listLoading.value = false;
                    }
                };

                const openDirModal = (mode, dir = null) => {
                    dirModalMode.value = mode;
                    if (mode === 'rename') {
                        const targetDir = dir || selectedDir.value;
                        if (!targetDir) return;
                        dirForm.value = {
                            name: targetDir['èŠ‚ç‚¹å'],
                            id: targetDir['ç¼–å·'],
                            parentCode: ''
                        };
                    } else {
                        dirForm.value = { name: '', id: '', parentCode: '' };
                    }
                    showDirModal.value = true;
                };

                const deleteDirectory = async (dir) => {
                    if (!dir) return;
                    if (!confirm(`ç¡®å®šåˆ é™¤ç›®å½•"${dir['èŠ‚ç‚¹å']}"å—ï¼Ÿåˆ é™¤ç›®å½•åï¼Œè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æŠ¥è¡¨ä¹Ÿå°†è¢«ç§»é™¤ã€‚`)) return;
                    try {
                        if (!sdk) sdk = await window.initializeSDK();
                        const result = await sdk.api.callButton({
                            panelCode: BUTTON_PANEL_CODE,
                            buttonName: 'åˆ é™¤',
                            buttonParam: { rowCodes: [dir['ç¼–å·']] }
                        });

                        if (result?.state === '200') {
                            // ä»flatListä¸­ç§»é™¤
                            const flatIdx = flatList.value.findIndex(n => n['ç¼–å·'] === dir['ç¼–å·']);
                            if (flatIdx !== -1) flatList.value.splice(flatIdx, 1);
                            
                            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ç›®å½•ï¼Œæ¸…ç©ºé€‰ä¸­çŠ¶æ€
                            if (selectedDirId.value === dir['ç¼–å·']) {
                                selectedDirId.value = null;
                                reportList.value = [];
                            }
                            
                            // æ¸…é™¤è¯¥ç›®å½•çš„tabs
                            if (dirTabsMap.value[dir['ç¼–å·']]) {
                                delete dirTabsMap.value[dir['ç¼–å·']];
                            }
                        } else {
                            throw new Error(result?.msg || 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (e) {
                        alert('åˆ é™¤ç›®å½•å¤±è´¥ï¼š' + e.message);
                    }
                };

                const submitDirModal = async () => {
                    if (!dirForm.value.name) return;
                    try {
                        const payload = {
                            nodeName: dirForm.value.name,
                            nodeType: 'ç›®å½•',
                            parentCode: dirModalMode.value === 'add-child' ? dirForm.value.parentCode : ''
                        };
                        if (dirModalMode.value === 'rename') {
                            payload.nodeId = dirForm.value.id;
                            payload.parentCode = dirForm.value.parentCode;
                        }
                        const result = await callSDKSaveNode(payload);
                        if (result?.state === '200') {
                            if (dirModalMode.value === 'rename') {
                                const idx = flatList.value.findIndex(n => n['ç¼–å·'] === dirForm.value.id);
                                if (idx !== -1) flatList.value[idx]['èŠ‚ç‚¹å'] = dirForm.value.name;
                            } else {
                                const newId = result?.data?.data?.['ç¼–å·'] || `${Date.now()}`;
                                const newNode = {
                                    'ç¼–å·': newId,
                                    'èŠ‚ç‚¹å': dirForm.value.name,
                                    'èŠ‚ç‚¹ç±»å‹': 'ç›®å½•',
                                    'parentCode': dirModalMode.value === 'add-child' ? dirForm.value.parentCode : ''
                                };
                                flatList.value.push(newNode);
                                selectedDirId.value = newId;
                                reportList.value = [];
                            }
                            showDirModal.value = false;
                        } else {
                            throw new Error(result?.msg || 'ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        alert('ä¿å­˜ç›®å½•å¤±è´¥ï¼š' + e.message);
                    }
                };

                const openReportModal = (mode) => {
                    if (!selectedDir.value) return;
                    reportModalMode.value = mode;
                    if (mode === 'edit') {
                        const target = reportList.value.find(r => r['ç¼–å·'] === selectedReportId.value);
                        if (!target) return;
                        reportForm.value = { name: target['èŠ‚ç‚¹å'], id: target['ç¼–å·'] };
                    } else {
                        reportForm.value = { name: '', id: '' };
                    }
                    showReportModal.value = true;
                };

                const submitReportModal = async () => {
                    if (!reportForm.value.name || !selectedDirId.value) return;
                    try {
                        const payload = {
                            nodeName: reportForm.value.name,
                            nodeType: 'æ˜ç»†æŠ¥è¡¨',
                            parentCode: selectedDirId.value
                        };
                        if (reportModalMode.value === 'edit') {
                            payload.nodeId = reportForm.value.id;
                        }

                        const result = await callSDKSaveNode(payload);
                        if (result?.state === '200') {
                            if (reportModalMode.value === 'edit') {
                                const idx = reportList.value.findIndex(r => r['ç¼–å·'] === reportForm.value.id);
                                if (idx !== -1) reportList.value[idx]['èŠ‚ç‚¹å'] = reportForm.value.name;
                                const flatIdx = flatList.value.findIndex(r => r['ç¼–å·'] === reportForm.value.id);
                                if (flatIdx !== -1) flatList.value[flatIdx]['èŠ‚ç‚¹å'] = reportForm.value.name;
                            } else {
                                const newId = result?.data?.data?.['ç¼–å·'] || `${Date.now()}`;
                                const newNode = {
                                    'ç¼–å·': newId,
                                    'èŠ‚ç‚¹å': reportForm.value.name,
                                    'èŠ‚ç‚¹ç±»å‹': 'æ˜ç»†æŠ¥è¡¨',
                                    'parentCode': selectedDirId.value
                                };
                                reportList.value.push(newNode);
                                flatList.value.push(newNode);
                                selectedReportId.value = newId;
                            }
                            resetToFirstPage();
                            showReportModal.value = false;
                        } else {
                            throw new Error(result?.msg || 'ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        alert('ä¿å­˜æŠ¥è¡¨å¤±è´¥ï¼š' + e.message);
                    }
                };

                const deleteReport = async () => {
                    if (!selectedReportId.value) return;
                    if (!confirm('ç¡®å®šåˆ é™¤è¯¥æŠ¥è¡¨å—ï¼Ÿ')) return;
                    try {
                        if (!sdk) sdk = await window.initializeSDK();
                        const result = await sdk.api.callButton({
                            panelCode: BUTTON_PANEL_CODE,
                            buttonName: 'åˆ é™¤',
                            buttonParam: { rowCodes: [selectedReportId.value] }
                        });

                        if (result?.state === '200') {
                            const idx = reportList.value.findIndex(r => r['ç¼–å·'] === selectedReportId.value);
                            if (idx !== -1) reportList.value.splice(idx, 1);
                            const flatIdx = flatList.value.findIndex(r => r['ç¼–å·'] === selectedReportId.value);
                            if (flatIdx !== -1) flatList.value.splice(flatIdx, 1);
                            selectedReportId.value = null;
                            resetToFirstPage();
                        } else {
                            throw new Error(result?.msg || 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (e) {
                        alert('åˆ é™¤æŠ¥è¡¨å¤±è´¥ï¼š' + e.message);
                    }
                };

                const handleSelect = async (node) => {
                    selectedDirId.value = node['ç¼–å·'];
                    selectedReportId.value = null;
                    searchKeyword.value = '';
                    currentPage.value = 1;
                    totalReports.value = 0;
                    await loadReportsForDir(node['ç¼–å·']);
                };

                // --- Directory Tab Switching ---
                const switchDirectory = async (dir) => {
                    selectedDirId.value = dir['ç¼–å·'];
                    searchKeyword.value = '';
                    currentPage.value = 1;
                    
                    // åˆå§‹åŒ–å½“å‰ç›®å½•çš„tabsç»“æ„
                    if (!dirTabsMap.value[dir['ç¼–å·']]) {
                        dirTabsMap.value[dir['ç¼–å·']] = {
                            activeTab: 'list',  // é»˜è®¤æ¿€æ´»åˆ—è¡¨tab
                            tabs: []
                        };
                    }

                    // å¦‚æœå½“å‰ç›®å½•æ²¡æœ‰æ¿€æ´»tabï¼Œæ¿€æ´»åˆ—è¡¨tab
                    if (!dirTabsMap.value[dir['ç¼–å·']].activeTab) {
                        dirTabsMap.value[dir['ç¼–å·']].activeTab = 'list';
                    }

                    await loadReportsForDir(dir['ç¼–å·']);
                };

                // --- Report Tab Management ---
                const openReportTab = (report) => {
                    const dirId = selectedDirId.value;
                    if (!dirId) return;

                    const nodeCode = report['ç¼–å·'];
                    const tabId = `editor-${nodeCode}`;
                    
                    // åˆå§‹åŒ–ç›®å½•tabsç»“æ„
                    if (!dirTabsMap.value[dirId]) {
                        dirTabsMap.value[dirId] = {
                            activeTab: 'list',
                            tabs: []
                        };
                    }

                    const dirTabs = dirTabsMap.value[dirId];
                    
                    // æ£€æŸ¥tabæ˜¯å¦å·²å­˜åœ¨
                    const existingTab = dirTabs.tabs.find(t => t.id === tabId);
                    if (existingTab) {
                        // å·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°è¯¥tab
                        dirTabs.activeTab = tabId;
                        return;
                    }

                    // åˆ›å»ºæ–°tab
                    const isDetail = report['èŠ‚ç‚¹ç±»å‹'] === 'æ˜ç»†æŠ¥è¡¨';
                    const url = (isDetail ? './expenseStatement.html' : './index.html') + 
                                '?nodeCode=' + encodeURIComponent(nodeCode);
                    
                    const newTab = {
                        id: tabId,
                        name: report['èŠ‚ç‚¹å'],
                        url: url,
                        nodeCode: nodeCode,
                        isListTab: false
                    };

                    dirTabs.tabs.push(newTab);
                    dirTabs.activeTab = tabId;
                };

                const switchTab = (tabId) => {
                    const dirId = selectedDirId.value;
                    if (!dirId || !dirTabsMap.value[dirId]) return;
                    dirTabsMap.value[dirId].activeTab = tabId;
                };

                const closeTab = (tabId) => {
                    const dirId = selectedDirId.value;
                    if (!dirId || !dirTabsMap.value[dirId]) return;
                    if (tabId === 'list') return;  // ä¸å…è®¸å…³é—­åˆ—è¡¨tab

                    const dirTabs = dirTabsMap.value[dirId];
                    const tabIndex = dirTabs.tabs.findIndex(t => t.id === tabId);
                    
                    if (tabIndex === -1) return;

                    // å¦‚æœå…³é—­çš„æ˜¯å½“å‰æ¿€æ´»tabï¼Œéœ€è¦åˆ‡æ¢åˆ°å…¶ä»–tab
                    if (dirTabs.activeTab === tabId) {
                        if (dirTabs.tabs.length > 1) {
                            // ä¼˜å…ˆåˆ‡æ¢åˆ°å³ä¾§tabï¼Œå¦åˆ™åˆ‡æ¢åˆ°å·¦ä¾§
                            const nextIndex = tabIndex < dirTabs.tabs.length - 1 ? tabIndex + 1 : tabIndex - 1;
                            dirTabs.activeTab = dirTabs.tabs[nextIndex].id;
                        } else {
                            // åªå‰©è¿™ä¸€ä¸ªç¼–è¾‘tabï¼Œå…³é—­åå›åˆ°åˆ—è¡¨tab
                            dirTabs.activeTab = 'list';
                        }
                    }

                    // åˆ é™¤tab
                    dirTabs.tabs.splice(tabIndex, 1);
                };

                // --- Iframe Communication ---
                const handleIframeLoad = (tab) => {
                    // iframeåŠ è½½å®Œæˆåï¼Œå¯ä»¥å‘é€åˆå§‹åŒ–æ•°æ®
                    const iframe = iframeRefs.value[tab.id];
                    if (!iframe || !iframe.contentWindow) return;

                    try {
                        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿iframeå†…éƒ¨è„šæœ¬å·²åŠ è½½
                        setTimeout(() => {
                            const message = {
                                type: 'INIT_NODE_CODE',
                                nodeCode: tab.nodeCode,
                                nodeName: tab.name,
                                parentCode: selectedDirId.value  // ä¼ é€’å½“å‰ç›®å½•ID
                            };
                            iframe.contentWindow.postMessage(message, '*');
                            console.log('å‘é€nodeCodeåˆ°ç¼–è¾‘é¡µé¢iframe:', message);
                        }, 100);
                    } catch (e) {
                        console.error('å‘é€æ¶ˆæ¯åˆ°iframeå¤±è´¥:', e);
                    }
                };

                const handleReportClick = (report) => {
                    openReportTab(report);
                };

                const refreshTree = async () => {
                    if (refreshLoading.value) return;
                    refreshLoading.value = true;
                    try {
                        await loadData();
                        selectedDirId.value = null;
                        reportList.value = [];
                    } catch (e) {
                        console.error('åˆ·æ–°ç›®å½•å¤±è´¥:', e);
                    } finally {
                        refreshLoading.value = false;
                    }
                };

                const refreshReports = async () => {
                    if (!selectedDirId.value) return;
                    await loadReportsForDir(selectedDirId.value);
                };

                onMounted(async () => { await loadData(); });

                return {
                    allDirectories,
                    treeData,
                    selectedDirId,
                    selectedDir,
                    refreshLoading,
                    reportList,
                    selectedReportId,
                    listLoading,
                    searchKeyword,
                    currentPage,
                    pageSize,
                    paginatedReports,
                    totalReports,
                    totalPages,
                    currentTabs,
                    currentActiveTab,
                    allTabs,
                    editorTabs,
                    iframeRefs,
                    switchDirectory,
                    openReportTab,
                    switchTab,
                    closeTab,
                    handleIframeLoad,
                    handleSelect,
                    handleReportClick,
                    prevPage,
                    nextPage,
                    resetToFirstPage,
                    handleSearch,
                    handlePageSizeChange,
                    refreshTree,
                    refreshReports,
                    showDirModal,
                    dirModalMode,
                    dirForm,
                    openDirModal,
                    submitDirModal,
                    deleteDirectory,
                    showReportModal,
                    reportModalMode,
                    reportForm,
                    openReportModal,
                    submitReportModal,
                    deleteReport,
                    getDirectoryTabCount
                };
            }
        }).mount('#app');
    </script>
</body>

</html>