	<!DOCTYPE html>
	<html lang="zh">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>明细表格查询</title>
		<link href="css/font-awesome-4.7.0.min.css" rel="stylesheet">
		<link rel="stylesheet" href="css/style.css">
		<!-- SDK引入 -->
	<script src="http://10.238.171.159:8090/wp-core/api/getPanelXSdk"></script>
		<style>
			* { box-sizing: border-box; margin: 0; padding: 0; }
			html, body { height: 100%; width: 100%; }
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				background-color: #f5f5f5;
				color: #333;
				display: flex;
				flex-direction: column;
			}
			
			.header {
				background: #fff;
				border-bottom: 1px solid #ddd;
				padding: 12px 20px;
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.header-title {
				font-size: 16px;
				font-weight: 600;
				color: #333;
			}

			.content {
				flex: 1;
				padding: 0;
				overflow: hidden;
				display: flex;
				flex-direction: column;
				align-items: stretch;
			}

			.table-container {
				flex: 1 1 auto;
				width: 100%;
				max-width: none;
				background: #fff;
				border-radius: 6px;
				box-shadow: 0 2px 8px rgba(0,0,0,0.1);
				padding: 12px; /* 适度内边距 */
				overflow: auto; /* 支持上下左右滚动 */
				box-sizing: border-box;
			}

			/* 使用与expenseStatement.html预览相同的表格样式 */
			.preview-cloned-table {
				border-collapse: collapse;
				width: auto; /* 改为auto让列宽自适应内容 */
				table-layout: auto; /* 改为auto让列宽根据内容自动调整 */
				max-width: none;
				box-shadow: 0 1px 0 rgba(0,0,0,0.04);
				background: white;
			}

			.preview-cloned-table th,
			.preview-cloned-table td {
				border: 1px solid #e6e6e6;
				padding: 8px 12px;
				min-width: 120px; /* 增加最小宽度 */
				box-sizing: border-box;
				white-space: nowrap;
				overflow: visible; /* 改为visible让内容完全显示 */
				position: relative;
			}

			.preview-cloned-table th {
				background-color: #f8f9fa;
				font-weight: 600;
				text-align: center;
				cursor: col-resize; /* 鼠标悬停时显示调整列宽的光标 */
				user-select: none;
			}

			.preview-cloned-table td {
				background-color: #fff;
				color: #333;
			}

			/* 列宽调整手柄 */
			.preview-cloned-table th::after {
				content: '';
				position: absolute;
				top: 0;
				right: 0;
				width: 5px;
				height: 100%;
				cursor: col-resize;
				z-index: 1;
			}

			.preview-cloned-table th:hover::after {
				background-color: rgba(0, 123, 255, 0.1);
			}

			.text-bold { font-weight: 700; }
			.text-italic { font-style: italic; }
			.text-underline { text-decoration: underline; }

			.no-data {
				text-align: center;
				padding: 40px;
				color: #999;
				font-size: 14px;
			}
		</style>
	</head>

	<body>
		<div class="header">
			<span class="header-title">明细报表查询</span>
		</div>

		<div class="content">
			<div class="table-container">
				<div id="table-content">
					<div class="no-data">等待加载配置数据...</div>
				</div>
			</div>
		</div>

		<script>
			console.log('明细报表查询预览页加载完成');

			// SDK实例和配置
			let sdk = null;
			let sdkConfig = {
				devDefaultBaseUrl: 'http://10.238.171.159:8090',
				busDomainCode: 'OctoCM_BDYTH'
			};
			
			// 存储当前配置信息
			let currentConfig = null;

			// 模拟的表数据映射（与expenseStatement.html保持一致）
			window.tableDataMap = {
				'客户信息表': {
					data: [
						{ '客户ID': 'C001', '客户姓名': '张三', '身份证号': '110101199001011234', '手机号': '13800138000' },
						{ '客户ID': 'C002', '客户姓名': '李四', '身份证号': '110101199002021234', '手机号': '13800138001' },
						{ '客户ID': 'C003', '客户姓名': '王五', '身份证号': '110101199003031234', '手机号': '13800138002' },
						{ '客户ID': 'C004', '客户姓名': '赵六', '身份证号': '110101199004041234', '手机号': '13800138003' },
						{ '客户ID': 'C005', '客户姓名': '孙七', '身份证号': '110101199005051234', '手机号': '13800138004' }
					]
				},
				'账户信息表': {
					data: [
						{ '账户ID': 'A001', '客户ID': 'C001', '账户类型': '储蓄账户', '开户日期': '2020-01-15' },
						{ '账户ID': 'A002', '客户ID': 'C001', '账户类型': '信用卡', '开户日期': '2020-03-20' },
						{ '账户ID': 'A003', '客户ID': 'C002', '账户类型': '储蓄账户', '开户日期': '2019-11-10' },
						{ '账户ID': 'A004', '客户ID': 'C003', '账户类型': '储蓄账户', '开户日期': '2021-05-22' },
						{ '账户ID': 'A005', '客户ID': 'C004', '账户类型': '信用卡', '开户日期': '2020-08-30' }
					]
				},
				'交易记录表': {
					data: [
						{ '交易ID': 'T001', '交易类型': '存款', '交易金额': '5000.00', '交易日期': '2024-01-10' },
						{ '交易ID': 'T002', '交易类型': '取款', '交易金额': '2000.00', '交易日期': '2024-01-15' },
						{ '交易ID': 'T003', '交易类型': '转账', '交易金额': '3000.00', '交易日期': '2024-01-20' },
						{ '交易ID': 'T004', '交易类型': '存款', '交易金额': '10000.00', '交易日期': '2024-02-05' },
						{ '交易ID': 'T005', '交易类型': '取款', '交易金额': '1500.00', '交易日期': '2024-02-10' }
					]
				}
			};

			// 样式复制相关常量和函数（与detailPreview.js保持一致）
			const STYLE_PROPS = [
				'background-color', 'background-image', 'background-size', 'background-position',
				'color', 'font-size', 'font-weight', 'font-style', 'font-family', 'line-height',
				'text-align', 'vertical-align', 'padding-top', 'padding-right', 'padding-bottom', 'padding-left',
				'border-top-width', 'border-right-width', 'border-bottom-width', 'border-left-width',
				'border-top-style', 'border-right-style', 'border-bottom-style', 'border-left-style',
				'border-top-color', 'border-right-color', 'border-bottom-color', 'border-left-color',
				'box-sizing', 'white-space', 'word-break', 'word-wrap', 'letter-spacing'
			];

			function copyComputedStylesToInline(sourceEl, targetEl, props = STYLE_PROPS) {
				if (!sourceEl || !targetEl) return;
				const cs = window.getComputedStyle(sourceEl);
				props.forEach(prop => {
					try {
						const v = cs.getPropertyValue(prop);
						if (v) {
							const jsProp = prop.replace(/-([a-z])/g, (m, p1) => p1.toUpperCase());
							targetEl.style[jsProp] = v;
						}
					} catch (e) {}
				});
			}

			// 初始化SDK
			async function initializeSDK() {
				try {
					const baseUrl = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
					const configUrl = baseUrl + '/config/sdk-config.json';
					
					try {
						const response = await fetch(configUrl);
						if (response.ok) {
							const config = await response.json();
							sdkConfig.devDefaultBaseUrl = config.apiBaseUrl || sdkConfig.devDefaultBaseUrl;
							sdkConfig.busDomainCode = config.busDomainCode || sdkConfig.busDomainCode;
							console.log('SDK配置已从文件加载:', sdkConfig);
						}
					} catch (error) {
						console.warn('无法加载SDK配置文件，使用默认配置');
					}

					if (typeof PanelXSdk === 'undefined') {
						console.error('PanelXSdk未定义，请确保SDK脚本已正确加载');
						return false;
					}

					sdk = new PanelXSdk({ 
						devDefaultBaseUrl: sdkConfig.devDefaultBaseUrl, 
						busDomainCode: sdkConfig.busDomainCode 
					});

					try {
						await sdk.user.login({ userName: 'admin', password: '123456' });
						console.log('SDK登录成功');
					} catch (e) { 
						console.warn('SDK登录失败:', e); 
					}

					return true;
				} catch (error) {
					console.error('SDK初始化失败:', error);
					return false;
				}
			}

			// 通过SDK查询数据
			async function queryDataFromSDK(config) {
				if (!sdk) {
					console.error('SDK未初始化');
					return null;
				}

				if (!config || !config.detailReportConfig) {
					console.error('配置信息缺失');
					return null;
				}

				const detailConfig = config.detailReportConfig;
				console.log('开始查询数据，配置:', detailConfig);

				try {
					// 构建查询参数 - 需要传入报表的code
					// TODO: 从配置中获取报表code，这里暂时使用测试code
					const reportCode = config.reportCode || "ef563b19_14b7_427d_b523_29b9f3d79d18";
					
					const params = {
						"panelCode": "IML_00001",
						"buttonName": "明细查询",
						"buttonParam": {
							"code": reportCode
						}
					};

					console.log('调用SDK查询，参数:', params);
					const result = await sdk.api.callButton(params);
					console.log('查询结果:', result);

					if (result && result.state === '200' && result.data) {
						return result.data;
					} else {
						console.error('查询失败:', result);
						return null;
					}
				} catch (error) {
					console.error('查询数据失败:', error);
					return null;
				}
			}

			// 监听来自父窗口的消息
			window.addEventListener('message', async function(event) {
				console.log('收到消息:', event.data);

				if (event.data.type === 'displayDetailTableConfig') {
					const config = event.data.config;
					console.log('收到明细表格配置:', config);
					currentConfig = config;
					
					// 确保SDK已初始化
					if (!sdk) {
						await initializeSDK();
					}
					
					// 尝试从SDK获取真实数据
					if (config.detailReportConfig && config.detailReportConfig.selectedCols && config.detailReportConfig.selectedCols.length > 0) {
						const queryResult = await queryDataFromSDK(config);
						if (queryResult && queryResult.left && queryResult.right) {
							// 使用SDK返回的数据填充表格
							displayDetailTableWithSDKData(config, queryResult);
							return;
						}
					}
					
					// 如果SDK查询失败或没有配置字段，使用模拟数据
					displayDetailTable(config);
				}
			});

			/**
			 * 使用SDK返回的数据填充表格
			 */
			function displayDetailTableWithSDKData(config, sdkData) {
				const container = document.getElementById('table-content');
				if (!config || !config.tableData || !sdkData) {
					container.innerHTML = '<div class="no-data">数据为空</div>';
					return;
				}

				console.log('使用SDK数据填充表格');
				
				// 创建虚拟表格
				const virtualDesignTable = createVirtualDesignTable(config.tableData);
				if (!virtualDesignTable) {
					container.innerHTML = '<div class="no-data">表格数据格式错误</div>';
					return;
				}

				// 克隆表格
				const cloneTable = virtualDesignTable.cloneNode(true);
				cloneTable.classList.add('preview-cloned-table');
				cloneTable.removeAttribute('id');

				// 复制样式
				copyTableComputedStyles(virtualDesignTable, cloneTable);

				// 收集字段映射
				const { fieldMap, maxFieldRow } = collectFieldMapAndMaxRow(virtualDesignTable);
				
				// 替换表头中的{fieldName}为中文名
				replaceHeaderWithChineseNames(cloneTable, fieldMap, sdkData.left);
				
				// 使用SDK数据填充
				fillTableWithSDKData(cloneTable, fieldMap, sdkData, maxFieldRow, config.detailReportConfig.selectedCols);

				// 重新编号
				renumberCloneTableRows(cloneTable);

				// 显示
				container.innerHTML = '';
				container.appendChild(cloneTable);
				
				// 添加列宽调整功能
				addColumnResizeFeature(cloneTable);
			}

			/**
			 * 替换表头中的{fieldName}为中文名
			 */
			function replaceHeaderWithChineseNames(cloneTable, fieldMap, leftFields) {
				if (!leftFields || !Array.isArray(leftFields)) return;
				
				// 建立字段名到中文名的映射
				const fieldNameToLabel = {};
				leftFields.forEach(field => {
					fieldNameToLabel[field.name] = field.label || field.name;
				});
				
				// 遍历所有表头行
				const allRows = Array.from(cloneTable.rows || []);
				allRows.forEach(row => {
					Array.from(row.cells || []).forEach((cell, colIndex) => {
						const mapping = fieldMap.get(colIndex);
						if (mapping && mapping.fieldName) {
							const cellText = cell.textContent || '';
							// 替换 {fieldName} 格式为中文名
							if (cellText.includes('{') && cellText.includes('}')) {
								const chineseName = fieldNameToLabel[mapping.fieldName] || mapping.fieldName;
								cell.textContent = chineseName;
							}
						}
					});
				});
			}

			/**
			 * 使用SDK返回的数据填充表格
			 */
			function fillTableWithSDKData(cloneTable, fieldMap, sdkData, maxFieldRow, selectedCols) {
				const { left, right } = sdkData;
				if (!left || !right || !Array.isArray(right)) {
					console.error('SDK数据格式错误');
					return;
				}

				console.log('字段映射:', left);
				console.log('数据行数:', right.length);
				console.log('选中的字段:', selectedCols);

				// 建立字段名到列索引的映射
				const fieldNameToIndex = {};
				left.forEach((field, index) => {
					fieldNameToIndex[field.name] = index;
				});

				const headerCount = (cloneTable.tHead && cloneTable.tHead.rows.length) ? cloneTable.tHead.rows.length : 0;
				const cloneTbody = (cloneTable.tBodies && cloneTable.tBodies[0]) || cloneTable.createTBody();

				let effectiveMaxFieldRow = maxFieldRow;
				if (effectiveMaxFieldRow < 0) {
					effectiveMaxFieldRow = cloneTable.rows.length - 1;
				}

				let insertIndexInTbody = 0;
				if (effectiveMaxFieldRow >= headerCount) {
					insertIndexInTbody = effectiveMaxFieldRow - headerCount + 1;
					if (insertIndexInTbody < 0) insertIndexInTbody = 0;
				}

				let templateRow = null;
				if (cloneTbody.rows.length > 0) {
					templateRow = cloneTbody.rows[cloneTbody.rows.length - 1];
				}

				const firstRow = (cloneTable.tHead && cloneTable.tHead.rows.length > 0) ? cloneTable.tHead.rows[0] :
								 ((cloneTable.rows && cloneTable.rows.length > 0) ? cloneTable.rows[0] : null);
				const colCount = firstRow ? firstRow.cells.length : 5;

				// 填充每一行数据
				for (let i = 0; i < right.length; i++) {
					const dataRow = right[i]; // 这是一个数组，按照left中的字段顺序
					const targetIndex = insertIndexInTbody + i;
					let targetRow = null;

					if (targetIndex < cloneTbody.rows.length) {
						targetRow = cloneTbody.rows[targetIndex];
					} else {
						if (templateRow) {
							targetRow = templateRow.cloneNode(true);
							Array.from(targetRow.cells || []).forEach(td => td.textContent = '');
						} else {
							targetRow = document.createElement('tr');
							for (let c = 0; c < colCount; c++) {
								const td = document.createElement('td');
								td.textContent = '';
								targetRow.appendChild(td);
							}
						}
						
						if (targetIndex >= cloneTbody.rows.length) {
							cloneTbody.appendChild(targetRow);
						} else {
							cloneTbody.insertBefore(targetRow, cloneTbody.rows[targetIndex]);
						}
					}

					// 填充每个单元格
					for (let c = 0; c < colCount; c++) {
						if (!targetRow.cells[c]) {
							while (targetRow.cells.length <= c) {
								const newTd = document.createElement('td');
								targetRow.appendChild(newTd);
							}
						}
						const td = targetRow.cells[c];
						const mapping = fieldMap.get(c);
						
						if (mapping && mapping.fieldName) {
							// 找到该字段在SDK返回数据中的位置
							const dataIndex = fieldNameToIndex[mapping.fieldName];
							if (dataIndex !== undefined && dataRow[dataIndex] !== undefined) {
								td.textContent = dataRow[dataIndex];
							} else {
								td.textContent = '';
							}
						}
					}
				}
			}

			/**
			 * 根据配置显示明细表格（使用与expenseStatement.html预览相同的逻辑）
			 */
			function displayDetailTable(config) {
				const container = document.getElementById('table-content');
				if (!config || !config.tableData) {
					container.innerHTML = '<div class="no-data">配置数据为空或格式错误</div>';
					return;
				}

				// 创建一个虚拟的design-table来重用预览逻辑
				const virtualDesignTable = createVirtualDesignTable(config.tableData);
				if (!virtualDesignTable) {
					container.innerHTML = '<div class="no-data">表格数据格式错误</div>';
					return;
				}

				// 克隆表格并应用样式
				const cloneTable = virtualDesignTable.cloneNode(true);
				cloneTable.classList.add('preview-cloned-table');
				cloneTable.removeAttribute('id');

				// 复制计算样式
				copyTableComputedStyles(virtualDesignTable, cloneTable);

				// 收集字段映射信息
				const { fieldMap, maxFieldRow } = collectFieldMapAndMaxRow(virtualDesignTable);
				const usedTables = new Set(Array.from(fieldMap.values()).map(v => v.tableName));

				// 填充数据
				fillTableData(cloneTable, fieldMap, usedTables, maxFieldRow);

				// 重新编号
				renumberCloneTableRows(cloneTable);

				// 显示
				container.innerHTML = '';
				container.appendChild(cloneTable);
				
				// 添加列宽调整功能
				addColumnResizeFeature(cloneTable);
			}

			/**
			 * 从配置数据创建虚拟的设计表格
			 */
			function createVirtualDesignTable(tableData) {
				if (!Array.isArray(tableData) || tableData.length === 0) {
					return null;
				}

				const table = document.createElement('table');
				table.id = 'virtual-design-table';
				
				const thead = document.createElement('thead');
				const tbody = document.createElement('tbody');

				// 判断数据格式
				if (Array.isArray(tableData[0])) {
					// 2D数组格式
					tableData.forEach((row, rowIdx) => {
						const tr = document.createElement('tr');
						
						row.forEach((cellInfo, cellIdx) => {
							const cell = rowIdx === 0 ? document.createElement('th') : document.createElement('td');
							
							// 解析单元格信息
							let cellContent = '';
							let cellType = 'text';
							let tableName = '';
							let fieldName = '';
							let displayName = '';
							
							if (typeof cellInfo === 'object' && cellInfo !== null) {
								cellContent = cellInfo.value || cellInfo.content || '';
								cellType = cellInfo.type || 'text';
								
								if (cellInfo.data) {
									try {
										const dataObj = typeof cellInfo.data === 'string' ? JSON.parse(cellInfo.data) : cellInfo.data;
										tableName = dataObj.table || dataObj.tableName || '';
										fieldName = dataObj.field || dataObj.fieldName || dataObj.name || '';
										displayName = dataObj.displayName || fieldName;
									} catch (e) {}
								}
								
								// 应用样式
								if (cellInfo.style) {
									try {
										const styleObj = typeof cellInfo.style === 'string' ? JSON.parse(cellInfo.style) : cellInfo.style;
										Object.keys(styleObj).forEach(key => {
											cell.style[key] = styleObj[key];
										});
									} catch (e) {}
								}
							} else {
								cellContent = String(cellInfo || '');
							}
							
							cell.textContent = cellContent;
							
							// 设置data属性
							if (cellType === 'field') {
								cell.dataset.type = 'field';
								if (tableName) cell.dataset.table = tableName;
								if (fieldName) cell.dataset.name = fieldName;
								if (displayName) cell.dataset.displayName = displayName;
							}
							
							tr.appendChild(cell);
						});
						
						if (rowIdx === 0) {
							thead.appendChild(tr);
						} else {
							tbody.appendChild(tr);
						}
					});
				} else if (typeof tableData[0] === 'object') {
					// 对象数组格式
					const columns = Object.keys(tableData[0]).filter(key => key !== '__row');
					
					// 创建表头
					const headerRow = document.createElement('tr');
					columns.forEach(col => {
						const th = document.createElement('th');
						const cellData = tableData[0][col];
						if (cellData && typeof cellData === 'object') {
							th.textContent = cellData.content || col;
							if (cellData.style) {
								try {
									const style = typeof cellData.style === 'string' ? JSON.parse(cellData.style) : cellData.style;
									Object.keys(style).forEach(key => {
										th.style[key] = style[key];
									});
								} catch (e) {}
							}
						} else {
							th.textContent = col;
						}
						headerRow.appendChild(th);
					});
					thead.appendChild(headerRow);
					
					// 创建数据行
					tableData.slice(1).forEach(row => {
						const tr = document.createElement('tr');
						columns.forEach(col => {
							const td = document.createElement('td');
							const cellData = row[col];
							
							if (cellData && typeof cellData === 'object') {
								td.textContent = cellData.content || '';
								const cellType = cellData.type || 'text';
								
								if (cellType === 'field' && cellData.data) {
									try {
										const dataObj = typeof cellData.data === 'string' ? JSON.parse(cellData.data) : cellData.data;
										td.dataset.type = 'field';
										if (dataObj.table) td.dataset.table = dataObj.table;
										if (dataObj.field) td.dataset.name = dataObj.field;
										if (dataObj.displayName) td.dataset.displayName = dataObj.displayName;
									} catch (e) {}
								}
								
								if (cellData.style) {
									try {
										const style = typeof cellData.style === 'string' ? JSON.parse(cellData.style) : cellData.style;
										Object.keys(style).forEach(key => {
											td.style[key] = style[key];
										});
									} catch (e) {}
								}
							} else {
								td.textContent = cellData || '';
							}
							
							tr.appendChild(td);
						});
						tbody.appendChild(tr);
					});
				}
				
				table.appendChild(thead);
				table.appendChild(tbody);
				return table;
			}

			/**
			 * 复制表格计算样式
			 */
			function copyTableComputedStyles(designTable, cloneTable) {
				if (!designTable || !cloneTable) return;

				const tableProps = ['width', 'max-width', 'font-family', 'font-size', 'border-collapse', 'box-sizing'];
				const tableCs = window.getComputedStyle(designTable);
				tableProps.forEach(p => {
					try {
						const v = tableCs.getPropertyValue(p);
						if (v) {
							const jsProp = p.replace(/-([a-z])/g, (m, p1) => p1.toUpperCase());
							cloneTable.style[jsProp] = v;
						}
					} catch (e) {}
				});

				const srcRows = Array.from(designTable.rows || []);
				const tgtRows = Array.from(cloneTable.rows || []);
				const rowCount = Math.min(srcRows.length, tgtRows.length);
				for (let r = 0; r < rowCount; r++) {
					const srcCells = Array.from(srcRows[r].cells || []);
					const tgtCells = Array.from(tgtRows[r].cells || []);
					const cellCount = Math.min(srcCells.length, tgtCells.length);
					for (let c = 0; c < cellCount; c++) {
						copyComputedStylesToInline(srcCells[c], tgtCells[c]);
					}
				}
			}

			/**
			 * 收集字段映射和最大字段行
			 */
			function collectFieldMapAndMaxRow(designTable) {
				const fieldMap = new Map();
				let maxFieldRow = -1;
				for (let r = 0; r < designTable.rows.length; r++) {
					const row = designTable.rows[r];
					for (let c = 0; c < row.cells.length; c++) {
						const cell = row.cells[c];
						if (cell && cell.dataset && cell.dataset.type === 'field' && cell.dataset.table && cell.dataset.name) {
							fieldMap.set(c, {
								tableName: cell.dataset.table,
								fieldName: cell.dataset.name,
								rowIndex: r
							});
							if (r > maxFieldRow) maxFieldRow = r;
						}
					}
				}
				return { fieldMap, maxFieldRow };
			}

			/**
			 * 填充表格数据
			 */
			function fillTableData(cloneTable, fieldMap, usedTables, maxFieldRow) {
				if (usedTables.size !== 1) return;

				const tableName = Array.from(usedTables)[0];
				if (!window.tableDataMap || !window.tableDataMap[tableName]) return;

				const tableData = window.tableDataMap[tableName].data || [];
				const headerCount = (cloneTable.tHead && cloneTable.tHead.rows.length) ? cloneTable.tHead.rows.length : 0;
				const cloneTbody = (cloneTable.tBodies && cloneTable.tBodies[0]) || cloneTable.createTBody();

				let effectiveMaxFieldRow = maxFieldRow;
				if (effectiveMaxFieldRow < 0) {
					effectiveMaxFieldRow = cloneTable.rows.length - 1;
				}

				let insertIndexInTbody = 0;
				if (effectiveMaxFieldRow >= headerCount) {
					insertIndexInTbody = effectiveMaxFieldRow - headerCount + 1;
					if (insertIndexInTbody < 0) insertIndexInTbody = 0;
				}

				let templateRow = null;
				if (cloneTbody.rows.length > 0) {
					templateRow = cloneTbody.rows[cloneTbody.rows.length - 1];
				}

				const firstRow = (cloneTable.tHead && cloneTable.tHead.rows.length > 0) ? cloneTable.tHead.rows[0] :
								 ((cloneTable.rows && cloneTable.rows.length > 0) ? cloneTable.rows[0] : null);
				const colCount = firstRow ? firstRow.cells.length : 5;

				for (let i = 0; i < tableData.length; i++) {
					const dataItem = tableData[i];
					const targetIndex = insertIndexInTbody + i;
					let targetRow = null;

					if (targetIndex < cloneTbody.rows.length) {
						targetRow = cloneTbody.rows[targetIndex];
					} else {
						if (templateRow) {
							targetRow = templateRow.cloneNode(true);
							Array.from(targetRow.cells || []).forEach(td => td.textContent = '');
						} else {
							targetRow = document.createElement('tr');
							for (let c = 0; c < colCount; c++) {
								const td = document.createElement('td');
								td.textContent = '';
								targetRow.appendChild(td);
							}
						}
						
						if (targetIndex >= cloneTbody.rows.length) {
							cloneTbody.appendChild(targetRow);
						} else {
							cloneTbody.insertBefore(targetRow, cloneTbody.rows[targetIndex]);
						}
					}

					for (let c = 0; c < colCount; c++) {
						if (!targetRow.cells[c]) {
							while (targetRow.cells.length <= c) {
								const newTd = document.createElement('td');
								targetRow.appendChild(newTd);
							}
						}
						const td = targetRow.cells[c];
						const mapping = fieldMap.get(c);
						if (mapping) {
							td.textContent = dataItem[mapping.fieldName] !== undefined ? dataItem[mapping.fieldName] : '';
						}
					}
				}
			}

			/**
			 * 重新编号所有tbody行
			 */
			function renumberCloneTableRows(cloneTable) {
				if (!cloneTable) return;
				let counter = 1;
				const tbodies = cloneTable.tBodies && cloneTable.tBodies.length ? Array.from(cloneTable.tBodies) : [];
				if (tbodies.length === 0) {
					const allRows = Array.from(cloneTable.rows || []);
					allRows.forEach(row => {
						if (row.cells && row.cells.length > 0) {
							row.cells[0].textContent = (counter++).toString();
						}
					});
					return;
				}
				tbodies.forEach(tb => {
					const rows = Array.from(tb.rows || []);
					rows.forEach(row => {
						if (row.cells && row.cells.length > 0) {
							row.cells[0].textContent = (counter++).toString();
						}
					});
				});
			}

			/**
			 * 显示数组格式的表格 (2D数组) - 已废弃，使用新的统一逻辑
			 */
			function displayArrayFormatTable_deprecated(rows) {
				const container = document.getElementById('table-content');
				const table = document.createElement('table');
				table.className = 'preview-table';

				const thead = document.createElement('thead');
				const tbody = document.createElement('tbody');

				// 收集所有用到的表名
				const usedTables = new Set();
				
				// 处理每一行
				rows.forEach((row, rowIdx) => {
					if (!Array.isArray(row)) return;

					const tr = document.createElement('tr');

					row.forEach((cellInfo, cellIdx) => {
						let cellContent = '';
						let cellStyle = {};
						let cellType = 'text';
						let tableName = '';
						let fieldName = '';

						// 解析单元格信息
						if (typeof cellInfo === 'object' && cellInfo !== null) {
							cellContent = cellInfo.value || cellInfo.content || '';
							cellType = cellInfo.type || 'text';
							
							// 从data字段中提取表名和字段名
							if (cellInfo.data) {
								try {
									const dataObj = typeof cellInfo.data === 'string' ? JSON.parse(cellInfo.data) : cellInfo.data;
									tableName = dataObj.table || dataObj.tableName || '';
									fieldName = dataObj.field || dataObj.fieldName || dataObj.name || '';
									
									if (tableName) {
										usedTables.add(tableName);
									}
								} catch (e) {
									console.warn('解析单元格data失败:', e);
								}
							}

							// 解析样式
							if (cellInfo.style) {
								try {
									cellStyle = typeof cellInfo.style === 'string' ? JSON.parse(cellInfo.style) : cellInfo.style;
								} catch (e) {
									console.warn('解析单元格样式失败:', e);
								}
							}
						} else {
							cellContent = String(cellInfo || '');
						}

						// 创建单元格
						const cell = rowIdx === 0 ? document.createElement('th') : document.createElement('td');
						
						// 应用样式
						if (cellStyle) {
							Object.keys(cellStyle).forEach(key => {
								cell.style[key] = cellStyle[key];
							});
						}

						// 第一行是表头
						if (rowIdx === 0) {
							cell.textContent = cellContent;
							thead.appendChild(cell);
						} else {
							// 数据行：如果是field类型，需要填充实际数据
							if (cellType === 'field' && tableName && fieldName) {
								// 这是一个字段单元格，需要根据行号填充数据
								const dataRowIndex = rowIdx - 1; // 减去表头行
								
								if (tableDataMap[tableName] && tableDataMap[tableName].data) {
									const tableData = tableDataMap[tableName].data;
									if (dataRowIndex < tableData.length) {
										const dataItem = tableData[dataRowIndex];
										cell.textContent = dataItem[fieldName] !== undefined ? dataItem[fieldName] : '';
									} else {
										cell.textContent = '';
									}
								} else {
									cell.textContent = cellContent;
								}
							} else {
								// 普通文本单元格
								cell.textContent = cellContent;
							}
							
							tr.appendChild(cell);
						}
					});

					if (rowIdx === 0) {
						thead.appendChild(tr);
					} else {
						tbody.appendChild(tr);
					}
				});

				// 如果有字段单元格，需要补充更多数据行
				if (usedTables.size === 1) {
					const tableName = Array.from(usedTables)[0];
					if (tableDataMap[tableName] && tableDataMap[tableName].data) {
						const tableData = tableDataMap[tableName].data;
						const existingDataRows = rows.length - 1; // 减去表头行
						
						// 如果数据行数多于配置中的行数，需要补充
						if (tableData.length > existingDataRows) {
							const templateRow = rows[rows.length - 1]; // 使用最后一行作为模板
							
							for (let i = existingDataRows; i < tableData.length; i++) {
								const tr = document.createElement('tr');
								const dataItem = tableData[i];
								
								templateRow.forEach((cellInfo, cellIdx) => {
									const cell = document.createElement('td');
									let tableName = '';
									let fieldName = '';
									let cellStyle = {};
									
									if (typeof cellInfo === 'object' && cellInfo !== null) {
										if (cellInfo.data) {
											try {
												const dataObj = typeof cellInfo.data === 'string' ? JSON.parse(cellInfo.data) : cellInfo.data;
												tableName = dataObj.table || dataObj.tableName || '';
												fieldName = dataObj.field || dataObj.fieldName || dataObj.name || '';
											} catch (e) {}
										}
										
										if (cellInfo.style) {
											try {
												cellStyle = typeof cellInfo.style === 'string' ? JSON.parse(cellInfo.style) : cellInfo.style;
											} catch (e) {}
										}
									}
									
									// 应用样式
									Object.keys(cellStyle).forEach(key => {
										cell.style[key] = cellStyle[key];
									});
									
									// 填充数据
									if (fieldName) {
										cell.textContent = dataItem[fieldName] !== undefined ? dataItem[fieldName] : '';
									} else {
										cell.textContent = '';
									}
									
									tr.appendChild(cell);
								});
								
								tbody.appendChild(tr);
							}
						}
					}
				}

				table.appendChild(thead);
				table.appendChild(tbody);
				container.innerHTML = '';
				container.appendChild(table);
			}

			/**
			 * 显示对象格式的表格 - 已废弃，使用新的统一逻辑
			 */
			function displayObjectFormatTable_deprecated(rows) {
				const container = document.getElementById('table-content');
				const table = document.createElement('table');
				table.className = 'preview-table';

				const thead = document.createElement('thead');
				const tbody = document.createElement('tbody');

				// 收集所有用到的表名
				const usedTables = new Set();

				// 找到所有的列（从第一行对象的键中获取，排除__row）
				let columns = [];
				if (rows.length > 0) {
					columns = Object.keys(rows[0]).filter(key => key !== '__row');
				}

				// 创建表头
				const headerRow = document.createElement('tr');
				columns.forEach(col => {
					const th = document.createElement('th');
					const cellData = rows[0][col];
					if (cellData && typeof cellData === 'object') {
						th.textContent = cellData.content || col;
						
						// 应用样式
						if (cellData.style) {
							try {
								const style = typeof cellData.style === 'string' ? JSON.parse(cellData.style) : cellData.style;
								Object.keys(style).forEach(key => {
									th.style[key] = style[key];
								});
							} catch (e) {}
						}
					} else {
						th.textContent = col;
					}
					headerRow.appendChild(th);
				});
				thead.appendChild(headerRow);

				// 创建数据行
				rows.slice(1).forEach((row, rowIdx) => {
					const tr = document.createElement('tr');
					
					columns.forEach(col => {
						const td = document.createElement('td');
						const cellData = row[col];
						
						if (cellData && typeof cellData === 'object') {
							let cellContent = cellData.content || '';
							const cellType = cellData.type || 'text';
							
							// 解析data字段
							let tableName = '';
							let fieldName = '';
							if (cellData.data) {
								try {
									const dataObj = typeof cellData.data === 'string' ? JSON.parse(cellData.data) : cellData.data;
									tableName = dataObj.table || dataObj.tableName || '';
									fieldName = dataObj.field || dataObj.fieldName || dataObj.name || '';
									
									if (tableName) {
										usedTables.add(tableName);
									}
								} catch (e) {}
							}
							
							// 如果是field类型，填充实际数据
							if (cellType === 'field' && tableName && fieldName) {
								if (tableDataMap[tableName] && tableDataMap[tableName].data) {
									const tableData = tableDataMap[tableName].data;
									if (rowIdx < tableData.length) {
										const dataItem = tableData[rowIdx];
										cellContent = dataItem[fieldName] !== undefined ? dataItem[fieldName] : '';
									}
								}
							}
							
							td.textContent = cellContent;
							
							// 应用样式
							if (cellData.style) {
								try {
									const style = typeof cellData.style === 'string' ? JSON.parse(cellData.style) : cellData.style;
									Object.keys(style).forEach(key => {
										td.style[key] = style[key];
									});
								} catch (e) {}
							}
						} else {
							td.textContent = cellData || '';
						}
						
						tr.appendChild(td);
					});
					
					tbody.appendChild(tr);
				});

				// 补充更多数据行（如果需要）
				if (usedTables.size === 1) {
					const tableName = Array.from(usedTables)[0];
					if (tableDataMap[tableName] && tableDataMap[tableName].data) {
						const tableData = tableDataMap[tableName].data;
						const existingDataRows = rows.length - 1;
						
						if (tableData.length > existingDataRows) {
							const templateRow = rows[rows.length - 1];
							
							for (let i = existingDataRows; i < tableData.length; i++) {
								const tr = document.createElement('tr');
								const dataItem = tableData[i];
								
								columns.forEach(col => {
									const td = document.createElement('td');
									const cellTemplate = templateRow[col];
									
									if (cellTemplate && typeof cellTemplate === 'object') {
										let fieldName = '';
										if (cellTemplate.data) {
											try {
												const dataObj = typeof cellTemplate.data === 'string' ? JSON.parse(cellTemplate.data) : cellTemplate.data;
												fieldName = dataObj.field || dataObj.fieldName || dataObj.name || '';
											} catch (e) {}
										}
										
										if (fieldName) {
											td.textContent = dataItem[fieldName] !== undefined ? dataItem[fieldName] : '';
										} else {
											td.textContent = '';
										}
										
										// 应用样式
										if (cellTemplate.style) {
											try {
												const style = typeof cellTemplate.style === 'string' ? JSON.parse(cellTemplate.style) : cellTemplate.style;
												Object.keys(style).forEach(key => {
													td.style[key] = style[key];
												});
											} catch (e) {}
										}
									} else {
										td.textContent = '';
									}
									
									tr.appendChild(td);
								});
								
								tbody.appendChild(tr);
							}
						}
					}
				}

				table.appendChild(thead);
				table.appendChild(tbody);
				container.innerHTML = '';
				container.appendChild(table);
			}

			/**
			 * 为表格添加列宽调整功能
			 */
			function addColumnResizeFeature(table) {
				if (!table) return;
				
				const headers = table.querySelectorAll('th');
				let isResizing = false;
				let currentHeader = null;
				let startX = 0;
				let startWidth = 0;
				
				headers.forEach((header, index) => {
					header.addEventListener('mousedown', function(e) {
						// 只在表头右侧边缘触发（5px范围内）
						const rect = this.getBoundingClientRect();
						const offsetX = e.clientX - rect.left;
						
						if (rect.width - offsetX <= 5) {
							isResizing = true;
							currentHeader = this;
							startX = e.clientX;
							startWidth = rect.width;
							
							e.preventDefault();
							document.body.style.cursor = 'col-resize';
						}
					});
				});
				
				document.addEventListener('mousemove', function(e) {
					if (!isResizing || !currentHeader) return;
					
					const diff = e.clientX - startX;
					const newWidth = Math.max(60, startWidth + diff); // 最小宽度60px
					
					// 设置当前列的所有单元格宽度
					const headerIndex = Array.from(currentHeader.parentElement.children).indexOf(currentHeader);
					const rows = currentHeader.closest('table').rows;
					
					for (let i = 0; i < rows.length; i++) {
						if (rows[i].cells[headerIndex]) {
							rows[i].cells[headerIndex].style.width = newWidth + 'px';
							rows[i].cells[headerIndex].style.minWidth = newWidth + 'px';
							rows[i].cells[headerIndex].style.maxWidth = newWidth + 'px';
						}
					}
				});
				
				document.addEventListener('mouseup', function() {
					if (isResizing) {
						isResizing = false;
						currentHeader = null;
						document.body.style.cursor = '';
					}
				});
			}

			// 测试数据（开发时使用）
			if (window.location.search.includes('test=1')) {
				setTimeout(() => {
					const testConfig = {
						"tableData": [
							[
								{"value": "", "type": "text"},
								{"value": "客户ID", "type": "text"},
								{"value": "客户姓名", "type": "text"},
								{"value": "身份证号", "type": "text"}
							],
							[
								{"value": "1", "type": "text"},
								{"value": "{客户信息表.客户ID}", "type": "field", "data": "{\"table\":\"客户信息表\",\"field\":\"客户ID\"}"},
								{"value": "{客户信息表.客户姓名}", "type": "field", "data": "{\"table\":\"客户信息表\",\"field\":\"客户姓名\"}"},
								{"value": "{客户信息表.身份证号}", "type": "field", "data": "{\"table\":\"客户信息表\",\"field\":\"身份证号\"}"}
							]
						]
					};
					displayDetailTable(testConfig);
				}, 100);
			}
			
			// 页面加载时初始化SDK
			document.addEventListener('DOMContentLoaded', async function() {
				console.log('页面加载完成，初始化SDK...');
				await initializeSDK();
			});
		</script>
	</body>

	</html>
