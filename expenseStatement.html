<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥è¡¨æ˜ç»†</title>
    <!-- Font Awesome -->
    <link href="css/font-awesome-4.7.0.min.css" rel="stylesheet">
    <!-- å¤–éƒ¨CSSå¼•ç”¨ -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/detailPreview.css">
</head>

<body>

    <!-- æ ‡é¢˜æ  -->
    <!-- <div class="header">
        <span>æŠ¥è¡¨æ˜ç»†</span>
    </div> -->

    <!-- ä¸»ä½“å®¹å™¨ -->
    <div class="main-container">

        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <div class="panel-header" onclick="toggleSection('left-panel')">
                <h3>æ•°æ®è¡¨</h3>
                <span id="left-panel-icon" class="collapse-icon">â—€</span>
            </div>
            <div id="left-panel-content">
                <div class="panel-section">
                    <div class="section-header">
                        <h3>æ•°æ®æºé€‰æ‹©</h3>
                    </div>
                    <div style="padding: 10px;">
                        <select id="datasource-select" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;">
                            <option value="">è¯·é€‰æ‹©æ•°æ®æº</option>
                        </select>
                        <select id="schema-select" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;" disabled>
                            <option value="">è¯·å…ˆé€‰æ‹©æ•°æ®æº</option>
                        </select>
                        <select id="table-select" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;" disabled>
                            <option value="">è¯·å…ˆé€‰æ‹©Schema</option>
                        </select>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="section-header">
                        <h3>å­—æ®µåˆ—è¡¨</h3>
                    </div>
                    <div class="data-table-tree">
                        <ul id="field-list-container" style="padding: 10px;">
                            <!-- åŠ¨æ€åŠ è½½å­—æ®µåˆ—è¡¨ -->
                            <li style="text-align: center; color: #999; padding: 20px;">
                                è¯·é€‰æ‹©è¡¨åŠ è½½å­—æ®µ
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´åŒºåŸŸ -->
        <div class="center-panel">
            <!-- æŸ¥è¯¢æ å·²ç§»é™¤ -->

            <!-- å·¥å…·æ¡ -->
            <div class="toolbar">
                <!-- æ–‡ä»¶æ“ä½œåŒº -->
                <div class="toolbar-group">
                    <button class="toolbar-btn save-btn"><i class="fa fa-save"></i></button>
                    <button class="toolbar-btn"><i class="fa fa-download"></i></button>
                    <button class="toolbar-btn clear-btn" title="æ¸…ç©ºé…ç½®"><i class="fa fa-trash"></i></button>
                    <button class="toolbar-btn preview-btn" title="é¢„è§ˆ"><i class="fa fa-eye"></i></button>
                    <button class="toolbar-btn view-page-btn" title="æŸ¥çœ‹é¡µ"><i class="fa fa-external-link"></i></button>
                </div>

                <!-- åˆ†éš”çº¿ -->
                <div class="toolbar-divider"></div>

                <!-- æ ¼å¼è®¾ç½®åŒº -->
                <div class="toolbar-group">
                    <div class="dropdown">
                        <button class="toolbar-btn dropdown-toggle"><i class="fa fa-table"></i></button>
                    </div>
                    <div class="dropdown">
                        <button id="font-color-btn" class="toolbar-btn dropdown-toggle" title="å­—ä½“é¢œè‰²">
                            <i class="fa fa-font"></i>
                        </button>
                        <div id="font-color-menu" class="dropdown-menu">
                            <div class="color-picker">
                                <div class="color-item" data-color="#000000" style="background-color: #000000;"></div>
                                <div class="color-item" data-color="#FF0000" style="background-color: #FF0000;"></div>
                                <div class="color-item" data-color="#0000FF" style="background-color: #0000FF;"></div>
                                <div class="color-item" data-color="#008000" style="background-color: #008000;"></div>
                                <div class="color-item" data-color="#FFA500" style="background-color: #FFA500;"></div>
                                <div class="color-item" data-color="#800080" style="background-color: #800080;"></div>
                                <div class="color-item" data-color="#FF00FF" style="background-color: #FF00FF;"></div>
                                <div class="color-item" data-color="#00FFFF" style="background-color: #00FFFF;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button id="fill-color-btn" class="toolbar-btn dropdown-toggle" title="å¡«å……è‰²"><i
                                class="fa fa-paint-brush"></i></button>
                        <div id="fill-color-menu" class="dropdown-menu">
                            <div class="color-picker">
                                <div class="color-item" data-color="#FFFFFF" style="background-color: #FFFFFF;"></div>
                                <div class="color-item" data-color="#FFFF00" style="background-color: #FFFF00;"></div>
                                <div class="color-item" data-color="#FFC0CB" style="background-color: #FFC0CB;"></div>
                                <div class="color-item" data-color="#ADD8E6" style="background-color: #ADD8E6;"></div>
                                <div class="color-item" data-color="#90EE90" style="background-color: #90EE90;"></div>
                                <div class="color-item" data-color="#D3D3D3" style="background-color: #D3D3D3;"></div>
                                <div class="color-item" data-color="#FFA07A" style="background-color: #FFA07A;"></div>
                                <div class="color-item" data-color="#E6E6FA" style="background-color: #E6E6FA;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button id="font-size-btn" class="toolbar-btn dropdown-toggle" title="å­—å·">
                            <i class="fa fa-text-height"></i>
                            <span class="font-size-value">10</span>
                        </button>
                        <div id="font-size-menu" class="dropdown-menu">
                            <div class="size-picker">
                                <div class="size-item" data-size="8">8</div>
                                <div class="size-item" data-size="10">10</div>
                                <div class="size-item" data-size="12">12</div>
                                <div class="size-item" data-size="14">14</div>
                                <div class="size-item" data-size="16">16</div>
                                <div class="size-item" data-size="18">18</div>
                                <div class="size-item" data-size="20">20</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åˆ†éš”çº¿ -->
                <div class="toolbar-divider"></div>

                <!-- æ–‡æœ¬æ ¼å¼åŒº -->
                <div class="toolbar-group">
                    <button id="bold-btn" class="toolbar-btn" title="åŠ ç²—"><i class="fa fa-bold"></i></button>
                    <button id="italic-btn" class="toolbar-btn" title="å€¾æ–œ"><i class="fa fa-italic"></i></button>
                    <button id="underline-btn" class="toolbar-btn" title="ä¸‹åˆ’çº¿"><i class="fa fa-underline"></i></button>
                </div>

                <!-- åˆ†éš”çº¿ -->
                <div class="toolbar-divider"></div>

                <!-- å¯¹é½æ–¹å¼åŒº -->
                <div class="toolbar-group">
                    <div class="dropdown">
                        <button class="toolbar-btn dropdown-toggle"><i class="fa fa-list-ul"></i></button>
                    </div>
                    <div class="dropdown">
                        <button class="toolbar-btn dropdown-toggle"><i class="fa fa-columns"></i></button>
                    </div>
                </div>

                <!-- åˆ†éš”çº¿ -->
                <div class="toolbar-divider"></div>

                <!-- è¡Œåˆ—æ“ä½œåŒº -->
                <div class="toolbar-group">
                    <button class="toolbar-btn" id="add-row-btn" title="æ·»åŠ è¡Œ"><i class="fa fa-plus"></i> è¡Œ</button>
                    <button class="toolbar-btn" id="add-col-btn" title="æ·»åŠ åˆ—"><i class="fa fa-plus"></i> åˆ—</button>
                </div>
            </div>

            <!-- å•å…ƒæ ¼é€‰ä¸­ä¿¡æ¯æ˜¾ç¤º -->
            <div class="cell-selection-info" id="cell-selection-info">
                <span class="cell-position">æœªé€‰ä¸­ä»»ä½•å•å…ƒæ ¼</span>
                <div class="cell-input-container">
                    <input type="text" class="cell-content-input" disabled placeholder="ç‚¹å‡»å•å…ƒæ ¼è¿›è¡Œç¼–è¾‘">
                </div>
            </div>

            <!-- è®¾è®¡åŒºåŸŸ -->
            <div class="design-area" id="design-area">
                <table id="design-table">
                    <!-- è¡¨æ ¼å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </table>
            </div>
        </div>

        <!-- å³ä¾§ä¿¡æ¯æ  -->
        <div class="right-panel">
            <div class="panel-header" onclick="toggleSection('right-panel')">
                <span id="right-panel-icon" class="collapse-icon">â–¶</span>
                <h3>å•å…ƒæ ¼ä¿¡æ¯</h3>
            </div>
            <div id="right-panel-content">
                <div class="cell-info" id="cell-info">
                    <div class="info-group">
                        <label>å•å…ƒæ ¼ç±»å‹:</label>
                        <select id="cell-type">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="dimension">ç»´åº¦å•å…ƒæ ¼</option>
                            <option value="indicator">æŒ‡æ ‡å•å…ƒæ ¼</option>
                            <option value="text">æ–‡æœ¬å•å…ƒæ ¼</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>å•å…ƒæ ¼ç¼–å·:</label>
                        <input type="text" id="cell-id" value="" readonly>
                    </div>
                    <div class="info-group">
                        <label>æ¥æºæŒ‡æ ‡:</label>
                        <input type="text" id="cell-source" value="" readonly>
                    </div>
                    <div class="info-group">
                        <label>æ•°æ®å•ä½:</label>
                        <select id="cell-unit">
                            <option value="">æ— </option>
                            <option value="yuan">å…ƒ</option>
                            <option value="thousand">åƒå…ƒ</option>
                            <option value="million">ä¸‡å…ƒ</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>æ˜¾ç¤ºç²¾åº¦:</label>
                        <select id="cell-precision">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>è®¡ç®—è§„åˆ™:</label>
                        <select id="cell-calc-rule">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="today">æœ¬æ—¥</option>
                            <option value="yesterday">æ˜¨æ—¥</option>
                            <option value="sum">æ±‚å’Œ</option>
                            <option value="avg">å¹³å‡å€¼</option>
                            <option value="count">è®¡æ•°</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>æ—¶é—´åº¦é‡:</label>
                        <select id="cell-time-unit">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="none">æ— </option>
                            <option value="day">æ—¥</option>
                            <option value="month">æœˆ</option>
                            <option value="quarter">å­£</option>
                            <option value="year">å¹´</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>å–å€¼æ–¹å¼:</label>
                        <select id="cell-value-type">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="point">æ—¶ç‚¹</option>
                            <option value="period">æ—¶æœŸ</option>
                        </select>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’®æ¨¡å— -->
    <div class="bottom-actions">
        <div class="actions-container">
            <button class="save-button">ä¿å­˜</button>
            <button class="cancel-button">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="preview-modal" class="preview-modal">
        <div id="modal-content" class="modal-content">
            <div class="modal-header">
                <h3>è¡¨æ ¼é¢„è§ˆ</h3>
                <button id="modal-close" class="modal-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <div id="preview-table-container" class="preview-table-container">
                    <table id="preview-table" class="preview-table">
                        <!-- è¡¨æ ¼å†…å®¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- å¼•å…¥æ‹–æ‹½åŠŸèƒ½å¤„ç†æ¨¡å— -->
    <script src="https://demo.kwaidoo.com/zbyth/process/wp-core/api/getPanelXSdk"></script>
    <script src="js/dragAndDropHandler.js"></script>
    <script src="js/expenseStatement.js"></script>
    <script src="js/detailPreview.js"></script>
    <script src="js/viewLauncher.js"></script>
    <script src="js/configManager.js"></script>
    <script src="js/sdkConfig.js"></script>
    <script src="js/toolbarActions.js"></script>
    
    <!-- åŠ è½½SDKé…ç½®æ–‡ä»¶ -->
    <script>
        // åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶åŠ è½½SDKé…ç½®
        if (window.SDK_CONFIG_SETTINGS) {
            SDK_CONFIG_SETTINGS.loadFromFile('config/sdk-config.json')
                .then(() => {
                    console.log('SDKé…ç½®å·²åŠ è½½');
                    SDK_CONFIG_SETTINGS.printConfig();
                })
                .catch(error => {
                    console.warn('åŠ è½½SDKé…ç½®æ–‡ä»¶å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®:', error);
                });
        }
    </script>
    
    <!-- é…ç½®æ¥æ”¶ä¸åº”ç”¨è„šæœ¬ -->
    <script>
        // å…¨å±€ä¿å­˜èŠ‚ç‚¹ä¿¡æ¯å’Œå½“å‰è¡¨æ ¼é…ç½®
        window.currentNodeInfo = {
            nodeId: null,
            nodeName: null,
            nodeType: 'æ˜ç»†æŠ¥è¡¨',
            parentCode: null,
            config: null
        };

        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data) {
                try {
                    console.log('æ˜ç»†æŠ¥è¡¨æ¥æ”¶åˆ°æ¶ˆæ¯:', event.data);
                    
                    // ä¿å­˜èŠ‚ç‚¹ä¿¡æ¯ç”¨äºä¿å­˜
                    if (event.data.nodeId !== undefined) {
                        window.currentNodeInfo = {
                            nodeId: event.data.nodeId || null,
                            nodeName: event.data.nodeName || null,
                            nodeType: 'æ˜ç»†æŠ¥è¡¨',
                            parentCode: event.data.parentCode || null,
                            config: event.data.config || null
                        };
                        console.log('å·²ä¿å­˜æ˜ç»†æŠ¥è¡¨èŠ‚ç‚¹ä¿¡æ¯:', window.currentNodeInfo);
                    }
                    
                    console.log('æ¥æ”¶åˆ°æ˜ç»†è¡¨æ ¼é…ç½®:', event.data.config);
                    
                    // ç­‰å¾…DOMåŠ è½½å®Œæˆååº”ç”¨é…ç½®
                    if (document.readyState === 'complete') {
                        applyConfigToTable(event.data.config);
                    } else {
                        window.addEventListener('load', function() {
                            applyConfigToTable(event.data.config);
                        });
                    }
                } catch (error) {
                    console.error('å¤„ç†æ˜ç»†è¡¨æ ¼é…ç½®æ—¶å‡ºé”™:', error);
                }
            }
        });
        
        // åº”ç”¨é…ç½®åˆ°è¡¨æ ¼
        function applyConfigToTable(config) {
            console.log('æ”¶åˆ°éœ€è¦åº”ç”¨çš„é…ç½®:', config);
            
            // ä¿å­˜é…ç½®ä¾›DOMContentLoadedä½¿ç”¨
            initialConfigToRestore = config;
            
            if (window.applyTableConfig) {
                console.log('åº”ç”¨é…ç½®åˆ°æ˜ç»†è¡¨æ ¼...');
                const success = window.applyTableConfig(config);
                
                if (success) {
                    console.log('æ˜ç»†è¡¨æ ¼é…ç½®åº”ç”¨æˆåŠŸ');
                } else {
                    console.error('æ˜ç»†è¡¨æ ¼é…ç½®åº”ç”¨å¤±è´¥');
                }
            } else {
                console.error('applyTableConfigå‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿configManager.jså·²æ­£ç¡®åŠ è½½');
            }
        }
    </script>

    <!-- SDKæ•°æ®æºå’Œè¡¨ç®¡ç†è„šæœ¬ -->
    <script>
        // SDKå®ä¾‹
        let sdk = null;
        let sdkConfig = {
            devDefaultBaseUrl: 'https://demo.kwaidoo.com/zbyth/process',
            busDomainCode: 'OctoCM_BDYTH'
        };
        // è®°å½•é€‰ä¸­çš„å­—æ®µ
        window.selectedCols = window.selectedCols || [];

        // åˆå§‹åŒ–SDK
        async function initializeSDK() {
            try {
                const baseUrl = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                const configUrl = baseUrl + '/config/sdk-config.json';
                
                try {
                    const response = await fetch(configUrl);
                    if (response.ok) {
                        const config = await response.json();
                        sdkConfig.devDefaultBaseUrl = config.apiBaseUrl || sdkConfig.devDefaultBaseUrl;
                        sdkConfig.busDomainCode = config.busDomainCode || sdkConfig.busDomainCode;
                        console.log('SDKé…ç½®å·²ä»æ–‡ä»¶åŠ è½½:', sdkConfig);
                    }
                } catch (error) {
                    console.warn('åŠ è½½SDKé…ç½®æ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
                }

                if (typeof PanelXSdk === 'undefined') {
                    console.error('PanelXSdkæœªå®šä¹‰ï¼Œè¯·ç¡®ä¿SDKè„šæœ¬å·²æ­£ç¡®åŠ è½½');
                    return false;
                }

                sdk = new PanelXSdk({ 
                    devDefaultBaseUrl: sdkConfig.devDefaultBaseUrl, 
                    busDomainCode: sdkConfig.busDomainCode 
                });

                try {
                    await sdk.user.login({ userName: 'admin', password: '123456' });
                    console.log('SDKç™»å½•æˆåŠŸ');
                } catch (e) { 
                    console.warn('SDKç™»å½•å¤±è´¥:', e); 
                }

                return true;
            } catch (err) {
                console.error('SDKåˆå§‹åŒ–å¤±è´¥:', err);
                return false;
            }
        }

        // åŠ è½½æ•°æ®æºåˆ—è¡¨
        async function loadDataSources() {
            try {
                if (!sdk) {
                    const initialized = await initializeSDK();
                    if (!initialized) {
                        console.error('SDKåˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•åŠ è½½æ•°æ®æº');
                        return;
                    }
                }

                console.log('å¼€å§‹æŸ¥è¯¢æ•°æ®æºåˆ—è¡¨...');
                const params = {
                    "panelCode": "IML_00005",
                    "pageNo": 1,
                    "pageSize": 100
                };

                const result = await sdk.api.queryFormDataList(params);
                console.log('æ•°æ®æºæŸ¥è¯¢è¿”å›ç»“æœ:', result);

                if (result && result.state === '200' && result.data && result.data.list) {
                    const datasourceSelect = document.getElementById('datasource-select');
                    datasourceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ•°æ®æº</option>';
                    
                    result.data.list.forEach(ds => {
                        const option = document.createElement('option');
                        option.value = ds['æ•°æ®æºåç§°'];
                        option.textContent = ds['æ•°æ®æºåç§°'] + ' (' + ds['æ•°æ®åº“ç±»å‹'] + ')';
                        datasourceSelect.appendChild(option);
                    });

                    console.log('æ•°æ®æºåˆ—è¡¨åŠ è½½æˆåŠŸï¼Œå…±' + result.data.list.length + 'ä¸ªæ•°æ®æº');
                } else {
                    console.error('æ•°æ®æºæŸ¥è¯¢å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®æºåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ ¹æ®æ•°æ®æºåç§°åŠ è½½è¡¨åˆ—è¡¨
        async function loadTablesByDataSource(datasourceName, schemaName) {
            try {
                if (!sdk) {
                    console.error('SDKæœªåˆå§‹åŒ–');
                    return;
                }

                console.log('å¼€å§‹æŸ¥è¯¢æ•°æ®æº[' + datasourceName + ']çš„è¡¨åˆ—è¡¨...');
                const params = {
                    "panelCode": "IML_00003",
                    "pageNo": 1,
                    "pageSize": 100
                };

                const result = await sdk.api.queryFormDataList(params);
                console.log('è¡¨ç®¡ç†æŸ¥è¯¢è¿”å›ç»“æœ:', result);

                if (result && result.state === '200' && result.data && result.data.list) {
                    let tables = result.data.list.filter(table => table['æ•°æ®æºåç§°'] === datasourceName);
                    // å¦‚æœæä¾›äº†schema,è¿›ä¸€æ­¥è¿‡æ»¤
                    if (schemaName && tables.length > 0) {
                        tables = tables.filter(table => table['æ¨¡å¼å'] === schemaName);
                    }
                    console.log('è¿‡æ»¤åçš„è¡¨åˆ—è¡¨:', tables);

                    window.currentTables = tables;

                    const tableSelect = document.getElementById('table-select');
                    tableSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¡¨</option>';
                    tableSelect.disabled = false;

                    tables.forEach(table => {
                        const option = document.createElement('option');
                        const tableName = table['è¡¨å'];
                        const displayName = table['ä¸­æ–‡å'] ? table['ä¸­æ–‡å'] + ' (' + tableName + ')' : tableName;
                        option.value = tableName;
                        option.textContent = displayName;
                        option.dataset.tableData = JSON.stringify(table);
                        tableSelect.appendChild(option);
                    });

                    console.log('è¡¨ä¸‹æ‹‰æ¡†å·²æ›´æ–°ï¼Œå…±' + tables.length + 'å¼ è¡¨');
                } else {
                    console.error('è¡¨ç®¡ç†æŸ¥è¯¢å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('åŠ è½½è¡¨åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½schemaåˆ—è¡¨
        async function loadSchemasByDataSource(datasourceName) {
            try {
                if (!sdk) {
                    console.error('SDKæœªåˆå§‹åŒ–');
                    return;
                }

                const schemaSelect = document.getElementById('schema-select');
                schemaSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
                schemaSelect.disabled = true;
                
                console.log('å¼€å§‹æŸ¥è¯¢æ•°æ®æº[' + datasourceName + ']çš„Schemaåˆ—è¡¨...');
                const params = {
                    "panelCode": "IML_00003",
                    "pageNo": 1,
                    "pageSize": 100
                };

                const result = await sdk.api.queryFormDataList(params);
                console.log('è¡¨ç®¡ç†æŸ¥è¯¢è¿”å›ç»“æœ:', result);

                if (result && result.state === '200' && result.data && result.data.list) {
                    // è¿‡æ»¤å‡ºå±äºå½“å‰æ•°æ®æºçš„è¡¨
                    const tables = result.data.list.filter(table => table['æ•°æ®æºåç§°'] === datasourceName);
                    console.log('å½“å‰æ•°æ®æºçš„è¡¨:', tables);
                    
                    // æå–å”¯ä¸€çš„schemaåç§°
                    const schemaSet = new Set();
                    tables.forEach(table => {
                        if (table['æ¨¡å¼å']) {
                            schemaSet.add(table['æ¨¡å¼å']);
                        }
                    });
                    
                    const schemas = Array.from(schemaSet).sort();
                    console.log('æå–çš„Schemaåˆ—è¡¨:', schemas);
                    
                    schemaSelect.innerHTML = '<option value="">è¯·é€‰æ‹©Schema</option>';
                    schemas.forEach(schema => {
                        const option = document.createElement('option');
                        option.value = schema;
                        option.textContent = schema;
                        schemaSelect.appendChild(option);
                    });
                    schemaSelect.disabled = false;
                    
                    console.log('Schemaåˆ—è¡¨å·²åŠ è½½,å…±' + schemas.length + 'ä¸ª');
                } else {
                    console.error('è¡¨ç®¡ç†æŸ¥è¯¢å¤±è´¥:', result);
                    schemaSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            } catch (error) {
                console.error('åŠ è½½Schemaåˆ—è¡¨å¤±è´¥:', error);
                const schemaSelect = document.getElementById('schema-select');
                schemaSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        // æ ¹æ®é€‰ä¸­çš„è¡¨åŠ è½½å­—æ®µåˆ—è¡¨
        function loadFieldsByTable(tableName) {
            if (!window.currentTables) {
                console.error('è¡¨æ•°æ®æœªåŠ è½½');
                return;
            }

            const table = window.currentTables.find(t => t['è¡¨å'] === tableName);
            if (!table) {
                console.error('æœªæ‰¾åˆ°è¡¨:', tableName);
                return;
            }

            console.log('åŠ è½½è¡¨å­—æ®µ:', tableName, table);

            let fields = [];
            try {
                if (table['è¡¨ç»“æ„json']) {
                    const fieldStr = table['è¡¨ç»“æ„json'];
                    fields = typeof fieldStr === 'string' ? JSON.parse(fieldStr) : fieldStr;
                }
            } catch (error) {
                console.error('è§£æè¡¨ç»“æ„JSONå¤±è´¥:', error, table['è¡¨ç»“æ„json']);
            }

            renderFieldList(fields, tableName);
        }

        // æ¸²æŸ“å­—æ®µåˆ—è¡¨
        function renderFieldList(fields, tableName) {
            const container = document.getElementById('field-list-container');
            
            if (!fields || fields.length === 0) {
                container.innerHTML = '<li style="text-align: center; color: #999; padding: 20px;">è¯¥è¡¨æ²¡æœ‰å­—æ®µ</li>';
                return;
            }

            container.innerHTML = '';

            fields.forEach(field => {
                const fieldItem = document.createElement('li');
                fieldItem.className = 'table-field draggable';
                fieldItem.draggable = true;
                fieldItem.setAttribute('data-table', tableName);
                fieldItem.setAttribute('data-field', field['å­—æ®µå']);
                fieldItem.style.padding = '8px 12px';
                fieldItem.style.cursor = 'move';
                fieldItem.style.borderBottom = '1px solid #eee';
                fieldItem.style.listStyle = 'none';
                
                const fieldDisplayName = field['å­—æ®µä¸­æ–‡å'] ? 
                    field['å­—æ®µä¸­æ–‡å'] + ' (' + field['å­—æ®µå'] + ')' : 
                    field['å­—æ®µå'];
                
                fieldItem.innerHTML = `
                    <i class="tree-item-icon" style="margin-right: 8px;">ğŸ“„</i>
                    <span class="tree-text">${fieldDisplayName}</span>
                `;

                fieldItem.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f0f0f0';
                });
                fieldItem.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });

                container.appendChild(fieldItem);
            });

            if (typeof initDragAndDrop === 'function') {
                initDragAndDrop();
                console.log('æ‹–æ‹½åŠŸèƒ½å·²é‡æ–°åˆå§‹åŒ–');
            }

            console.log('å­—æ®µåˆ—è¡¨æ¸²æŸ“å®Œæˆï¼Œå…±' + fields.length + 'ä¸ªå­—æ®µ');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        let initialConfigToRestore = null;  // ç”¨äºå­˜å‚¨éœ€è¦æ¢å¤çš„é…ç½®
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ•°æ®æº');
            
            setTimeout(async function() {
                await loadDataSources();
                
                // ä¼˜å…ˆä½¿ç”¨ä»postMessageä¼ æ¥çš„é…ç½®(å­˜å‚¨åœ¨initialConfigToRestoreä¸­)
                let configToUse = initialConfigToRestore?.detailReportConfig || window.currentNodeInfo?.config;

                // æ¢å¤é€‰ä¸­çš„å­—æ®µ
                if (configToUse && configToUse.selectedCols) {
                    window.selectedCols = configToUse.selectedCols || [];
                    console.log('å·²æ¢å¤é€‰ä¸­çš„å­—æ®µ:', window.selectedCols);
                }

                if (configToUse && configToUse.selectedDataSource) {
                    const datasourceSelect = document.getElementById('datasource-select');
                    const option = Array.from(datasourceSelect.options).find(opt => opt.value === configToUse.selectedDataSource);
                    if (option) {
                        datasourceSelect.value = configToUse.selectedDataSource;
                        console.log('å·²æ¢å¤æ•°æ®æºé€‰æ‹©:', configToUse.selectedDataSource);
                        await loadSchemasByDataSource(configToUse.selectedDataSource);
                        
                        if (configToUse.selectedSchema) {
                            const schemaSelect = document.getElementById('schema-select');
                            const schemaOption = Array.from(schemaSelect.options).find(opt => opt.value === configToUse.selectedSchema);
                            if (schemaOption) {
                                schemaSelect.value = configToUse.selectedSchema;
                                console.log('å·²æ¢å¤Schemaé€‰æ‹©:', configToUse.selectedSchema);
                                await loadTablesByDataSource(configToUse.selectedDataSource, configToUse.selectedSchema);
                                
                                if (configToUse.selectedTable) {
                                    const tableSelect = document.getElementById('table-select');
                                    const tableOption = Array.from(tableSelect.options).find(opt => opt.value === configToUse.selectedTable);
                                    if (tableOption) {
                                        tableSelect.value = configToUse.selectedTable;
                                        console.log('å·²æ¢å¤è¡¨é€‰æ‹©:', configToUse.selectedTable);
                                        loadFieldsByTable(configToUse.selectedTable);
                                    }
                                }
                            }
                        }
                    }
                }
            }, 500);

            document.getElementById('datasource-select').addEventListener('change', async function(e) {
                const datasourceName = e.target.value;
                console.log('é€‰æ‹©æ•°æ®æº:', datasourceName);
                
                const schemaSelect = document.getElementById('schema-select');
                const tableSelect = document.getElementById('table-select');
                
                schemaSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ•°æ®æº</option>';
                schemaSelect.disabled = true;
                tableSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©Schema</option>';
                tableSelect.disabled = true;
                document.getElementById('field-list-container').innerHTML = 
                    '<li style="text-align: center; color: #999; padding: 20px;">è¯·é€‰æ‹©è¡¨åŠ è½½å­—æ®µ</li>';
                
                if (datasourceName) {
                    await loadSchemasByDataSource(datasourceName);
                    
                    if (window.currentNodeInfo) {
                        if (!window.currentNodeInfo.config) {
                            window.currentNodeInfo.config = {};
                        }
                        window.currentNodeInfo.config.selectedDataSource = datasourceName;
                        delete window.currentNodeInfo.config.selectedSchema;
                        delete window.currentNodeInfo.config.selectedTable;
                        window.selectedCols = [];
                        console.log('å·²ä¿å­˜æ•°æ®æºé€‰æ‹©:', datasourceName);
                    }
                }
            });

            document.getElementById('schema-select').addEventListener('change', async function(e) {
                const schemaName = e.target.value;
                console.log('é€‰æ‹©Schema:', schemaName);
                
                const datasourceName = document.getElementById('datasource-select').value;
                const tableSelect = document.getElementById('table-select');
                
                tableSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©Schema</option>';
                tableSelect.disabled = true;
                document.getElementById('field-list-container').innerHTML = 
                    '<li style="text-align: center; color: #999; padding: 20px;">è¯·é€‰æ‹©è¡¨åŠ è½½å­—æ®µ</li>';
                
                if (schemaName && datasourceName) {
                    await loadTablesByDataSource(datasourceName, schemaName);
                    
                    if (window.currentNodeInfo) {
                        if (!window.currentNodeInfo.config) {
                            window.currentNodeInfo.config = {};
                        }
                        window.currentNodeInfo.config.selectedSchema = schemaName;
                        delete window.currentNodeInfo.config.selectedTable;
                        window.selectedCols = [];
                        console.log('å·²ä¿å­˜Schemaé€‰æ‹©:', schemaName);
                    }
                }
            });

            document.getElementById('table-select').addEventListener('change', function(e) {
                const tableName = e.target.value;
                console.log('é€‰æ‹©è¡¨:', tableName);
                
                if (tableName) {
                    loadFieldsByTable(tableName);
                    // æ¸…ç©ºä¹‹å‰é€‰ä¸­çš„å­—æ®µ
                    window.selectedCols = [];
                    
                    if (window.currentNodeInfo) {
                        if (!window.currentNodeInfo.config) {
                            window.currentNodeInfo.config = {};
                        }
                        window.currentNodeInfo.config.selectedTable = tableName;
                        console.log('å·²ä¿å­˜è¡¨é€‰æ‹©:', tableName);
                    }
                } else {
                    document.getElementById('field-list-container').innerHTML = 
                        '<li style="text-align: center; color: #999; padding: 20px;">è¯·é€‰æ‹©è¡¨åŠ è½½å­—æ®µ</li>';
                }
            });
        });
    </script>
</body>
</html>